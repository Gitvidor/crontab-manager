<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crontab Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header">
        <h1><a href="/">Crontab Manager</a></h1>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">Tasks</button>
            <button class="tab" onclick="switchTab('atjobs')">At Jobs</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('cron')">Cron Logs</button>
            <button class="tab" onclick="switchTab('logs')">Audit Logs</button>
        </div>
        <div class="host-selector">
            <div class="selector-group">
                <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></label>
                <select id="machineSelect" onchange="switchMachine(this.value)">
                </select>
            </div>
            <div class="connection-status" title="Connection status">
                <span class="status-dot" id="connectionStatus"></span>
            </div>
        </div>
        <div class="user-info" id="userMenu">
            <span class="user-name">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="7" r="4" />
                    <path d="M5.5 21a6.5 6.5 0 0 1 13 0z" />
                </svg>
                <strong>{{ username }}</strong>
                <svg class="dropdown-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </span>
            <div class="user-dropdown">
                {% if user_role == 'admin' %}
                <div class="user-dropdown-item" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
                <div class="user-dropdown-divider"></div>
                {% endif %}
                <a href="/logout" class="user-dropdown-item danger">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </div>

    <div class="collapse-controls">
        <div class="filter-controls">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-btn" data-filter="active" onclick="setFilter('active')">Active</button>
            <button class="filter-btn" data-filter="paused" onclick="setFilter('paused')">Paused</button>
        </div>
        <button class="collapse-toggle-btn" id="collapseToggleBtn" onclick="toggleAllGroups()" title="Expand All">
            <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 10l5 5 5-5" />
                <path d="M7 5l5 5 5-5" />
            </svg>
            <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 14l5-5 5 5" />
                <path d="M7 19l5-5 5 5" />
            </svg>
        </button>
        <div class="search-wrapper">
            <input type="text" class="search-box" id="searchBox" placeholder="Search tasks, commands, groups..."
                oninput="taskCurrentPage=1; filterTasks()">
            <button class="case-toggle" id="caseToggle" onclick="toggleCaseSensitive()"
                title="Case Sensitive">Aa</button>
        </div>
        <button class="new-group-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="showNewGroupForm()"{% endif %}><span class="plus-icon">+</span> New Group</button>
    </div>

    <div id="newGroupForm" class="new-group-form">
        <input type="text" id="newGroupTitle" placeholder="Enter group name">
        <button class="create-btn" onclick="createGroup()">Create</button>
        <button class="cancel-btn" onclick="hideNewGroupForm()">Cancel</button>
    </div>

    <div id="taskList" class="task-list active"></div>
    <div class="pagination" id="taskPagination"></div>

    <!-- At Jobs é¢æ¿ (ä¸€æ¬¡æ€§ä¸´æ—¶ä»»åŠ¡) -->
    <div id="atJobsPanel" class="at-jobs-panel">
        <div class="at-jobs-header">
            <span>ä¸€æ¬¡æ€§ä¸´æ—¶ä»»åŠ¡ (at)</span>
            <button class="refresh-btn" onclick="loadAtJobs()" title="åˆ·æ–°">âŸ³</button>
        </div>

        <!-- æ¨¡æ¿å¿«æ·é€‰æ‹©åŒº -->
        <div class="at-template-bar">
            <span class="at-template-label">æ¨¡æ¿:</span>
            <div class="at-template-list" id="atTemplateList">
                <span class="template-empty">æš‚æ— æ¨¡æ¿</span>
            </div>
            <button class="at-template-add-btn{% if user_role == 'viewer' %} no-permission{% endif %}"
                    {% if user_role != 'viewer' %}onclick="showTemplateForm()"{% endif %}>
                <span class="plus-icon">+</span> æ–°æ¨¡æ¿
            </button>
        </div>

        <!-- æ¨¡æ¿ç¼–è¾‘è¡¨å•ï¼ˆå†…è”ï¼‰ -->
        <div id="templateForm" class="template-inline-form" style="display:none">
            <input type="text" id="templateName" placeholder="æ¨¡æ¿åç§°">
            <input type="text" id="templateCommand" placeholder="å‘½ä»¤">
            <select id="templateTimePreset">
                <option value="now + 5 minutes">5 åˆ†é’Ÿå</option>
                <option value="now + 15 minutes">15 åˆ†é’Ÿå</option>
                <option value="now + 30 minutes">30 åˆ†é’Ÿå</option>
                <option value="now + 1 hour">1 å°æ—¶å</option>
                <option value="now + 2 hours">2 å°æ—¶å</option>
                <option value="now + 1 day">1 å¤©å</option>
                <option value="tomorrow">æ˜å¤©æ­¤æ—¶</option>
            </select>
            <button class="template-save-btn" onclick="saveTemplate()">ä¿å­˜</button>
            <button class="template-cancel-btn" onclick="hideTemplateForm()">å–æ¶ˆ</button>
            <button class="template-delete-btn" id="templateDeleteBtn" onclick="deleteEditingTemplate()" style="display:none" title="åˆ é™¤æ¨¡æ¿">&times;</button>
        </div>

        <!-- åˆ›å»ºæ–°ä»»åŠ¡è¡¨å• -->
        <div class="at-job-form{% if user_role == 'viewer' %} no-permission{% endif %}">
            <div class="at-job-form-row">
                <div class="at-time-group">
                    <label>æ‰§è¡Œæ—¶é—´:</label>
                    <select id="atTimeMode" onchange="toggleAtTimeMode()">
                        <option value="relative">ç›¸å¯¹æ—¶é—´</option>
                        <option value="absolute">æŒ‡å®šæ—¶é—´</option>
                    </select>
                    <select id="atTimePreset" class="at-time-relative">
                        <option value="now + 5 minutes">5 åˆ†é’Ÿå</option>
                        <option value="now + 15 minutes">15 åˆ†é’Ÿå</option>
                        <option value="now + 30 minutes">30 åˆ†é’Ÿå</option>
                        <option value="now + 1 hour">1 å°æ—¶å</option>
                        <option value="now + 2 hours">2 å°æ—¶å</option>
                        <option value="now + 1 day">1 å¤©å</option>
                        <option value="tomorrow">æ˜å¤©æ­¤æ—¶</option>
                    </select>
                    <input type="datetime-local" id="atDatetime" class="at-time-absolute" style="display:none">
                </div>
            </div>
            <div class="at-job-form-row">
                <div class="at-command-group">
                    <label>å‘½ä»¤:</label>
                    <input type="text" id="atCommand" placeholder="è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤">
                </div>
                <button class="at-create-btn" {% if user_role != 'viewer' %}onclick="createAtJob()"{% endif %}>åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="at-job-list-header">
            <span class="at-col-expand"></span>
            <span class="at-col-id">ID</span>
            <span class="at-col-time">è®¡åˆ’æ—¶é—´</span>
            <span class="at-col-queue">é˜Ÿåˆ—</span>
            <span class="at-col-actions"></span>
        </div>
        <div class="at-job-list" id="atJobList">
            <div class="log-empty">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div id="historyView" class="history-view">
        <div class="history-header">
            <span>Current Version</span>
            <div class="history-header-btns">
                <button class="help-toggle-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditHelp()"{% endif %} id="editHelpBtn" title="Syntax Help">?</button>
                <button class="history-btn diff-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditMode()"{% endif %} id="editToggleBtn">Edit</button>
                <button class="history-btn cancel-edit-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="cancelEditMode()"{% endif %} id="cancelEditBtn"
                    style="display: none;">Cancel</button>
            </div>
        </div>
        <div class="edit-help-panel" id="editHelpPanel" style="display: none;">
            <div class="help-content">
                <div class="help-title">ğŸ“ Edit ç¼–è¾‘è¯­æ³•</div>
                <div class="help-example">
                    <span class="help-desc">1. åˆ›å»ºæ–°ç»„å¹¶æ·»åŠ ä»»åŠ¡</span>
                    <code></code>
                    <code>  â†ç©ºè¡Œ</code>
                    <code># æ–°ç»„åç§°</code>
                    <code># ä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼‰</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">â†’ ç©ºè¡Œ + æ³¨é‡Šè¡Œ + ä»»åŠ¡è¡Œ</span>
                </div>
                <div class="help-example">
                    <span class="help-desc">2. åœ¨å·²æœ‰ä»»åŠ¡çš„ä»»åŠ¡ç»„å†…æ·»åŠ ä»»åŠ¡</span>
                    <code>... ç»„å†…å…¶ä»–ä»»åŠ¡ ...</code>
                    <code># ä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼‰</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">â†’ ç´§è·Ÿåœ¨ç»„å†…æœ€åä¸€ä¸ªä»»åŠ¡åæ·»åŠ ï¼Œæ— ç©ºè¡Œ</span>
                </div>
            </div>
        </div>
        <div class="raw-editor-section" id="rawEditorSection">
            <div class="code-editor">
                <pre class="code-highlight" id="codeHighlight"></pre>
                <textarea id="rawContent" oninput="updateHighlight()" onscroll="syncHighlightScroll()"
                    readonly></textarea>
            </div>
        </div>

        <div class="history-header">
            <span>History Version</span>
        </div>
        <div class="history-list" id="historyList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="historyPagination"></div>
    </div>

    <div id="cronLogs" class="cron-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="cronLogSource">-</code></span>
            <button class="refresh-btn" onclick="loadCronLogs()" title="Refresh">âŸ³</button>
        </div>
        <input type="text" id="cronSearch" class="audit-search" placeholder="Search logs..." oninput="filterCronLogs()">
        <div class="log-header">
            <span class="cron-col-time">Time</span>
            <span class="cron-col-host">Host</span>
            <span class="cron-col-details">Details</span>
        </div>
        <div class="cron-log-list" id="cronLogList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="cronPagination"></div>
    </div>

    <div id="auditLogs" class="audit-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="auditLogSource">-</code></span>
        </div>
        <input type="text" id="auditSearch" class="audit-search" placeholder="Search logs..." oninput="filterAuditLogs()">
        <div class="log-header">
            <span class="log-col-time">Time</span>
            <span class="log-col-user">
                User
                <span class="col-filter" onclick="toggleFilterDropdown('user')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="userFilterDropdown"></div>
            </span>
            <span class="log-col-action">
                Action
                <span class="col-filter" onclick="toggleFilterDropdown('action')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="actionFilterDropdown"></div>
            </span>
            <span class="log-col-details">Details</span>
        </div>
        <div class="log-list" id="logList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="auditPagination"></div>
    </div>

    <!-- Settings Tab (ä»… admin å¯è§) -->
    {% if user_role == 'admin' %}
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-section">
            <h3>User Management</h3>
            <div class="user-form">
                <input type="text" id="newUsername" placeholder="Username">
                <input type="password" id="newPassword" placeholder="Password">
                <select id="newRole">
                    <option value="viewer">Viewer</option>
                    <option value="editor">Editor</option>
                    <option value="admin">Admin</option>
                </select>
                <button class="add-user-btn" onclick="createUser()">Add User</button>
            </div>
            <div class="user-list-header">
                <span class="user-col-name">Username</span>
                <span class="user-col-role">Role</span>
                <span class="user-col-machines">Machines</span>
                <span class="user-col-actions"></span>
            </div>
            <div class="user-list" id="userList">
                <div class="log-empty">Loading...</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="message" class="message"></div>

    <!-- Undo æ’¤é”€æç¤ºæ¡ -->
    <div id="undoToast" class="undo-toast">
        <span class="undo-text">Task deleted</span>
        <button class="undo-btn" onclick="performUndo()">Undo</button>
        <span class="undo-countdown">5s</span>
    </div>

    <!-- ç‰ˆæœ¬å¯¹æ¯”å¼¹çª— -->
    <div id="diffModal" class="diff-modal">
        <div class="diff-modal-content">
            <div class="diff-modal-header">
                <span>Version Diff</span>
                <button class="diff-close-btn" onclick="closeDiffModal()">&times;</button>
            </div>
            <div class="diff-modal-body">
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <button class="diff-nav-btn" id="diffPrevBtn" onclick="navigateDiff(-1)" title="Previous version">â€¹</button>
                        <span>Backup: <span id="diffBackupTime" class="diff-title-slide"></span></span>
                        <button class="diff-nav-btn" id="diffNextBtn" onclick="navigateDiff(1)" title="Next version">â€º</button>
                    </div>
                    <pre class="diff-content" id="diffBackup"></pre>
                </div>
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <span class="diff-nav-placeholder"></span>
                        <span>Current</span>
                        <span class="diff-nav-placeholder"></span>
                    </div>
                    <pre class="diff-content" id="diffCurrent"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿å˜é‡ä¼ é€’ -->
    <script>
        const USER_ROLE = '{{ user_role }}';
        const USER_CAN_EDIT = USER_ROLE === 'editor' || USER_ROLE === 'admin';
        const USER_CAN_ADMIN = USER_ROLE === 'admin';
    </script>
    <!-- ä¸»è„šæœ¬ -->
    <script src="/static/js/app.js"></script>
</body>

</html>
