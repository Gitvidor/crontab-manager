<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crontab Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header">
        <h1><a href="/">Crontab Manager</a></h1>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">Cron Jobs</button>
            <button class="tab" onclick="switchTab('history')">Cron History</button>
            <button class="tab" onclick="switchTab('cron')">Cron Logs</button>
            <button class="tab" onclick="switchTab('atjobs')">At Jobs</button>
            <button class="tab" onclick="switchTab('logs')">Audit Logs</button>
        </div>
        <div class="host-selector">
            <div class="selector-group">
                <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></label>
                <select id="machineSelect" onchange="switchMachine(this.value)">
                </select>
            </div>
            <div class="connection-status" title="Connection status">
                <span class="status-dot" id="connectionStatus"></span>
            </div>
        </div>
        <div class="user-info" id="userMenu">
            <span class="user-name">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="7" r="4" />
                    <path d="M5.5 21a6.5 6.5 0 0 1 13 0z" />
                </svg>
                <strong>{{ username }}</strong>
                <svg class="dropdown-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </span>
            <div class="user-dropdown">
                {% if user_role == 'admin' %}
                <div class="user-dropdown-item" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
                <div class="user-dropdown-divider"></div>
                {% endif %}
                <a href="/logout" class="user-dropdown-item danger">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </div>

    <div class="collapse-controls">
        <div class="filter-controls">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-btn" data-filter="active" onclick="setFilter('active')">Active</button>
            <button class="filter-btn" data-filter="paused" onclick="setFilter('paused')">Paused</button>
        </div>
        <button class="collapse-toggle-btn" id="collapseToggleBtn" onclick="toggleAllGroups()" title="Expand All">
            <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 10l5 5 5-5" />
                <path d="M7 5l5 5 5-5" />
            </svg>
            <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 14l5-5 5 5" />
                <path d="M7 19l5-5 5 5" />
            </svg>
        </button>
        <div class="search-wrapper">
            <input type="text" class="search-box" id="searchBox" placeholder="Search tasks, commands, groups..."
                oninput="taskCurrentPage=1; filterTasks()">
            <button class="case-toggle" id="caseToggle" onclick="toggleCaseSensitive()"
                title="Case Sensitive">Aa</button>
        </div>
        <button class="new-group-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="showNewGroupForm()"{% endif %}><span class="plus-icon">+</span> New Group</button>
    </div>

    <div id="newGroupForm" class="new-group-form">
        <input type="text" id="newGroupTitle" placeholder="Enter group name">
        <button class="create-btn" onclick="createGroup()">Create</button>
        <button class="cancel-btn" onclick="hideNewGroupForm()">Cancel</button>
    </div>

    <div id="taskList" class="task-list active"></div>
    <div class="pagination" id="taskPagination"></div>

    <!-- At Jobs Panel (One-time Tasks) -->
    <div id="atJobsPanel" class="at-jobs-panel">
        <div class="cron-log-header">
            <span class="cron-log-source">At Jobs: <code>One-time scheduled tasks</code></span>
            <button class="refresh-btn" onclick="refreshAtPanel()" title="Refresh">‚ü≥</button>
        </div>

        <!-- Template Quick Selection -->
        <div class="at-template-bar">
            <span class="at-template-label">Template:</span>
            <div class="at-template-list" id="atTemplateList">
                <span class="template-empty">No templates</span>
            </div>
        </div>

        <!-- Template Edit Form -->
        <div id="templateForm" class="at-job-form template-form" style="display:none">
            <div class="template-form-content">
                <div class="at-job-form-row">
                    <div class="at-time-group">
                        <label>Name:</label>
                        <input type="text" id="templateName" placeholder="Template name" style="flex:1; min-width:200px">
                    </div>
                </div>
                <div class="at-job-form-row">
                    <div class="at-time-group">
                        <label>Time:</label>
                        <select id="templateTimeMode" onchange="toggleTemplateTimeMode()">
                            <option value="relative">Relative</option>
                            <option value="timeonly">Time Today</option>
                        </select>
                        <input type="number" id="templateTimeValue" class="tpl-time-relative" min="1" max="999" value="5" style="width:60px">
                        <select id="templateTimeUnit" class="tpl-time-relative">
                            <option value="minutes" selected>minutes</option>
                            <option value="hours">hours</option>
                            <option value="days">days</option>
                        </select>
                        <input type="time" id="templateTimeOnly" class="tpl-time-only" style="display:none">
                    </div>
                </div>
                <div class="at-job-form-row">
                    <div class="at-command-group">
                        <label>Command:</label>
                        <input type="text" id="templateCommand" placeholder="Enter command">
                    </div>
                    <button class="at-create-btn" onclick="saveTemplate()">Save</button>
                    <button class="template-cancel-btn" onclick="hideTemplateForm()">Cancel</button>
                </div>
            </div>
            <button class="btn-delete-circle template-delete-btn" id="templateDeleteBtn" onclick="deleteEditingTemplate()" style="display:none" title="Delete"></button>
        </div>

        <!-- Create New Task Form -->
        <div class="at-job-form{% if user_role == 'viewer' %} no-permission{% endif %}">
            <div class="at-job-form-row">
                <div class="at-time-group">
                    <label>Execute at:</label>
                    <select id="atTimeMode" onchange="toggleAtTimeMode()">
                        <option value="relative">Relative</option>
                        <option value="timeonly">Time Today</option>
                        <option value="absolute">Specific Date</option>
                    </select>
                    <input type="number" id="atRelativeValue" class="at-time-relative" min="1" max="999" value="5" style="width:60px">
                    <select id="atRelativeUnit" class="at-time-relative">
                        <option value="minutes" selected>minutes</option>
                        <option value="hours">hours</option>
                        <option value="days">days</option>
                    </select>
                    <input type="time" id="atTimeOnly" class="at-time-only" style="display:none">
                    <input type="datetime-local" id="atDatetime" class="at-time-absolute" style="display:none">
                </div>
            </div>
            <div class="at-job-form-row">
                <div class="at-command-group">
                    <label>Command:</label>
                    <input type="text" id="atCommand" placeholder="Enter command to execute">
                </div>
                <button class="at-create-btn" {% if user_role != 'viewer' %}onclick="createAtJob()"{% endif %}>Create</button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="at-filter-section">
            <div class="at-filter-group">
                <button class="at-filter-btn" data-filter="all" onclick="setAtFilter('all')">All</button>
                <button class="at-filter-btn active" data-filter="pending" onclick="setAtFilter('pending')">Pending</button>
                <button class="at-filter-btn" data-filter="executed" onclick="setAtFilter('executed')">Executed</button>
                <button class="at-filter-btn" data-filter="cancelled" onclick="setAtFilter('cancelled')">Cancelled</button>
            </div>
            <button class="at-cleanup-btn{% if user_role != 'admin' %} no-permission{% endif %}"
                    {% if user_role == 'admin' %}onclick="cleanupAtHistory()"{% endif %} title="Clean up history">
                Clean
            </button>
        </div>

        <!-- Unified Task List -->
        <div class="at-job-list-header">
            <span class="at-col-status">Status</span>
            <span class="at-col-command">Command</span>
            <span class="at-col-scheduled">Scheduled</span>
            <span class="at-col-executed">Executed</span>
            <span class="at-col-actions"></span>
        </div>
        <div class="at-job-list" id="atJobList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="at-job-pagination" id="atJobPagination"></div>
    </div>

    <div id="historyView" class="history-view">
        <div class="history-header">
            <span>Current Version</span>
            <div class="history-header-btns">
                <button class="help-toggle-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditHelp()"{% endif %} id="editHelpBtn" title="Syntax Help">?</button>
                <button class="history-btn diff-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditMode()"{% endif %} id="editToggleBtn">Edit</button>
                <button class="history-btn cancel-edit-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="cancelEditMode()"{% endif %} id="cancelEditBtn"
                    style="display: none;">Cancel</button>
            </div>
        </div>
        <div class="edit-help-panel" id="editHelpPanel" style="display: none;">
            <div class="help-content">
                <div class="help-title">üìù Edit ÁºñËæëËØ≠Ê≥ï</div>
                <div class="help-example">
                    <span class="help-desc">1. ÂàõÂª∫Êñ∞ÁªÑÂπ∂Ê∑ªÂä†‰ªªÂä°</span>
                    <code></code>
                    <code>  ‚ÜêÁ©∫Ë°å</code>
                    <code># Êñ∞ÁªÑÂêçÁß∞</code>
                    <code># ‰ªªÂä°ÂêçÁß∞ÔºàÂèØÈÄâÔºâ</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">‚Üí Á©∫Ë°å + Ê≥®ÈáäË°å + ‰ªªÂä°Ë°å</span>
                </div>
                <div class="help-example">
                    <span class="help-desc">2. Âú®Â∑≤Êúâ‰ªªÂä°ÁöÑ‰ªªÂä°ÁªÑÂÜÖÊ∑ªÂä†‰ªªÂä°</span>
                    <code>... ÁªÑÂÜÖÂÖ∂‰ªñ‰ªªÂä° ...</code>
                    <code># ‰ªªÂä°ÂêçÁß∞ÔºàÂèØÈÄâÔºâ</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">‚Üí Á¥ßË∑üÂú®ÁªÑÂÜÖÊúÄÂêé‰∏Ä‰∏™‰ªªÂä°ÂêéÊ∑ªÂä†ÔºåÊó†Á©∫Ë°å</span>
                </div>
            </div>
        </div>
        <div class="raw-editor-section" id="rawEditorSection">
            <div class="code-editor">
                <pre class="code-highlight" id="codeHighlight"></pre>
                <textarea id="rawContent" oninput="updateHighlight()" onscroll="syncHighlightScroll()"
                    readonly></textarea>
            </div>
        </div>

        <div class="history-header">
            <span>History Version</span>
        </div>
        <div class="history-list" id="historyList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="historyPagination"></div>
    </div>

    <div id="cronLogs" class="cron-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="cronLogSource">-</code></span>
            <button class="refresh-btn" onclick="loadCronLogs()" title="Refresh">‚ü≥</button>
        </div>
        <input type="text" id="cronSearch" class="audit-search" placeholder="Search logs..." oninput="filterCronLogs()">
        <div class="log-header">
            <span class="cron-col-time">Time</span>
            <span class="cron-col-host">Host</span>
            <span class="cron-col-details">Details</span>
        </div>
        <div class="cron-log-list" id="cronLogList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="cronPagination"></div>
    </div>

    <div id="auditLogs" class="audit-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="auditLogSource">-</code></span>
        </div>
        <input type="text" id="auditSearch" class="audit-search" placeholder="Search logs..." oninput="filterAuditLogs()">
        <div class="log-header">
            <span class="log-col-time">Time</span>
            <span class="log-col-user">
                User
                <span class="col-filter" onclick="toggleFilterDropdown('user')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="userFilterDropdown"></div>
            </span>
            <span class="log-col-action">
                Action
                <span class="col-filter" onclick="toggleFilterDropdown('action')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="actionFilterDropdown"></div>
            </span>
            <span class="log-col-details">Details</span>
        </div>
        <div class="log-list" id="logList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="auditPagination"></div>
    </div>

    <!-- Settings Tab (‰ªÖ admin ÂèØËßÅ) -->
    {% if user_role == 'admin' %}
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-section">
            <h3>User Management</h3>
            <div class="user-form">
                <input type="text" id="newUsername" placeholder="Username">
                <input type="password" id="newPassword" placeholder="Password">
                <select id="newRole">
                    <option value="viewer">Viewer</option>
                    <option value="editor">Editor</option>
                    <option value="admin">Admin</option>
                </select>
                <button class="add-user-btn" onclick="createUser()">Add User</button>
            </div>
            <div class="user-list-header">
                <span class="user-col-name">Username</span>
                <span class="user-col-role">Role</span>
                <span class="user-col-machines">Machines</span>
                <span class="user-col-actions"></span>
            </div>
            <div class="user-list" id="userList">
                <div class="log-empty">Loading...</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="message" class="message"></div>

    <!-- Undo Êí§ÈîÄÊèêÁ§∫Êù° -->
    <div id="undoToast" class="undo-toast">
        <span class="undo-text">Task deleted</span>
        <button class="undo-btn" onclick="performUndo()">Undo</button>
        <span class="undo-countdown">5s</span>
    </div>

    <!-- ÁâàÊú¨ÂØπÊØîÂºπÁ™ó -->
    <div id="diffModal" class="diff-modal">
        <div class="diff-modal-content">
            <div class="diff-modal-header">
                <span>Version Diff</span>
                <button class="diff-close-btn" onclick="closeDiffModal()">&times;</button>
            </div>
            <div class="diff-modal-body">
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <button class="diff-nav-btn" id="diffPrevBtn" onclick="navigateDiff(-1)" title="Previous version">‚Äπ</button>
                        <span>Backup: <span id="diffBackupTime" class="diff-title-slide"></span></span>
                        <button class="diff-nav-btn" id="diffNextBtn" onclick="navigateDiff(1)" title="Next version">‚Ä∫</button>
                    </div>
                    <pre class="diff-content" id="diffBackup"></pre>
                </div>
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <span class="diff-nav-placeholder"></span>
                        <span>Current</span>
                        <span class="diff-nav-placeholder"></span>
                    </div>
                    <pre class="diff-content" id="diffCurrent"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊùøÂèòÈáè‰º†ÈÄí -->
    <script>
        const USER_ROLE = '{{ user_role }}';
        const USER_CAN_EDIT = USER_ROLE === 'editor' || USER_ROLE === 'admin';
        const USER_CAN_ADMIN = USER_ROLE === 'admin';
    </script>
    <!-- ‰∏ªËÑöÊú¨ -->
    <script src="/static/js/app.js"></script>
</body>

</html>
