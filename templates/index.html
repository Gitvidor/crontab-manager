<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crontab Manager</title>
    <style>
        /* CSS 变量系统 */
        :root {
            --primary: #4A90D9;
            --primary-hover: #357ABD;
            --success: #4CAF50;
            --success-hover: #45a049;
            --warning: #FFA726;
            --danger: #FF5F57;
            --danger-border: #E24B41;
            --macos-yellow: #FEBC2E;
            --macos-yellow-border: #E1A73E;

            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-hover: #e2e8f0;

            --text-primary: #1a2332;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;

            --border-color: #e2e8f0;
            --border-light: #f1f5f9;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;

            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);

            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            padding: 0 var(--space-5) var(--space-5) var(--space-5);
            max-width: 1200px;
            margin: 0 auto;
            color: var(--text-primary);
            line-height: 1.5;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 0;
            font-weight: 600;
            font-size: 20px;
            white-space: nowrap;
        }

        /* 顶部导航栏 */
        .header {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-1);
            padding: 8px var(--space-4);
            padding-right: 120px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
        }

        .user-name {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: 13px;
            color: var(--text-secondary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            cursor: default;
            transition: all var(--transition-fast);
        }

        .user-info:hover .user-name {
            background: var(--bg-hover);
        }

        .user-name strong {
            color: var(--text-primary);
        }

        .user-name .dropdown-arrow {
            margin-left: 2px;
            transition: transform var(--transition-fast);
        }

        .user-info:hover .user-name .dropdown-arrow {
            transform: rotate(180deg);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 140px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-4px);
            transition: all var(--transition-fast);
            z-index: 9999;
        }

        .user-info:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .user-dropdown-item:first-child {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .user-dropdown-item:last-child {
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .user-dropdown-item:hover {
            background: var(--bg-hover);
        }

        .user-dropdown-item.danger:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        .user-dropdown-item svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .user-dropdown-item.danger:hover svg {
            color: var(--danger);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: var(--space-1) 0;
        }

        /* 日志视图 */
        .audit-logs {
            display: none;
        }

        .audit-logs.active {
            display: block;
        }

        /* Settings 用户管理视图 */
        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .settings-section h3 {
            margin: 0 0 var(--space-4);
            font-size: 16px;
            color: var(--text-primary);
        }

        .user-form {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
        }

        .user-form input,
        .user-form select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
        }

        .user-form input {
            flex: 1;
            min-width: 120px;
        }

        .user-form select {
            min-width: 150px;
        }

        .add-user-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .add-user-btn:hover {
            background: var(--primary-hover);
        }

        .user-list {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-item:hover {
            background: var(--bg-hover);
        }

        .user-item-name {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-role-select {
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            margin-right: var(--space-3);
            border: 1px solid var(--border);
            cursor: pointer;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .user-role-select.admin {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        .user-role-select.editor {
            background: var(--warning-light);
            color: var(--warning);
            border-color: var(--warning);
        }

        .user-role-select.viewer {
            background: var(--success-light);
            color: var(--success);
            border-color: var(--success);
        }

        .user-item-machines {
            font-size: 12px;
            color: var(--text-secondary);
            margin-right: var(--space-3);
        }

        .user-item-actions {
            display: flex;
            gap: var(--space-2);
        }

        .user-item-actions button {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .user-item-actions button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .user-item-actions button.delete:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Cron执行日志视图 */
        .cron-logs {
            display: none;
        }

        .cron-logs.active {
            display: block;
        }

        .cron-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
            padding: var(--space-2) var(--space-3);
            min-height: 48px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .cron-log-source {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .cron-log-source code {
            background: var(--bg-hover);
            padding: 2px var(--space-2);
            border-radius: var(--radius-sm);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
        }

        .refresh-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn.spinning {
            animation: spin-refresh 0.6s ease-in-out;
        }

        @keyframes spin-refresh {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .cron-log-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .cron-log-line {
            padding: var(--space-2) var(--space-4);
            border-bottom: 1px solid var(--border-light);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .cron-log-line:last-child {
            border-bottom: none;
        }

        .cron-log-line:hover {
            background: var(--bg-tertiary);
        }

        .cron-time {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            min-width: 140px;
        }

        .cron-host {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 2px 8px 2px 4px;
            color: var(--text-secondary);
            min-width: 100px;
        }

        .cron-host svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .cron-details {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            flex: 1;
            word-break: break-all;
        }

        .cron-cmd-highlight {
            color: var(--primary);
            font-weight: 500;
        }

        .cron-raw {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            flex: 1;
            word-break: break-all;
        }

        .cron-log-error {
            text-align: center;
            padding: var(--space-6);
            color: var(--danger);
        }

        .audit-search {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            outline: none;
            margin-bottom: var(--space-2);
            box-sizing: border-box;
        }

        .audit-search:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.1);
        }

        .log-header {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-2) var(--space-4);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .log-col-time { min-width: 140px; }
        .log-col-user, .log-col-action { position: relative; }
        .log-col-user { min-width: 80px; }
        .log-col-action { min-width: 160px; }
        .log-col-details { flex: 1; }

        .cron-col-time { min-width: 140px; }
        .cron-col-host { min-width: 100px; }
        .cron-col-details { flex: 1; }

        .col-filter {
            font-size: 10px;
            color: var(--text-muted);
            margin-left: 4px;
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .col-filter:hover, .col-filter.active {
            color: var(--primary);
        }

        .filter-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            min-width: 120px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 100;
        }

        .filter-dropdown.show { display: block; }

        .filter-option {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: normal;
            color: var(--text-primary);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .filter-option:hover { background: var(--bg-hover); }
        .filter-option.active { background: var(--primary); color: white; }
        .filter-option.clear { color: var(--text-muted); font-style: italic; }

        .log-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .log-item {
            padding: var(--space-2) var(--space-4);
            border-bottom: 1px solid var(--border-light);
            font-size: 12px;
            display: flex;
            gap: var(--space-4);
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-item:hover {
            background: var(--bg-tertiary);
        }

        .log-time {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            min-width: 140px;
        }

        .log-user {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--primary);
            font-weight: 500;
            font-size: 11px;
            padding: 2px 8px 2px 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .log-user svg {
            width: 12px;
            height: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .log-action {
            font-weight: 500;
            min-width: 120px;
        }

        .log-action.login {
            color: var(--success);
        }

        .log-action.logout {
            color: var(--text-muted);
        }

        .log-action.add,
        .log-action.create {
            color: var(--success);
        }

        .log-action.delete {
            color: var(--danger);
        }

        .log-action.update,
        .log-action.toggle,
        .log-action.save {
            color: var(--primary);
        }

        .log-details {
            color: var(--text-secondary);
            flex: 1;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .log-empty {
            text-align: center;
            padding: var(--space-6);
            color: var(--text-muted);
        }

        .tabs {
            display: flex;
            gap: var(--space-1);
        }

        .tab {
            padding: 8px 18px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            position: relative;
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width var(--transition-fast);
            border-radius: 1px;
        }

        .tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab.active::after {
            width: 100%;
        }

        .tab:hover:not(.active)::after {
            width: 50%;
            background: var(--border-color);
        }

        /* 主机选择器 */
        .host-selector {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-left: auto;
        }

        .host-selector .selector-group {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 4px;
            gap: 4px;
        }

        .host-selector .selector-group label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 8px;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
        }

        .host-selector .selector-group label svg {
            width: 15px;
            height: 15px;
            opacity: 0.6;
        }

        .host-selector select {
            padding: 6px 30px 6px 12px;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%234a90d9' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            min-width: 100px;
        }

        .host-selector select:hover {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .host-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: background var(--transition-fast);
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 4px var(--success);
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        .status-dot.checking {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 任务列表视图 */
        .task-list {
            display: none;
        }

        .task-list.active {
            display: block;
        }

        .task-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 3px var(--space-2);
            margin-bottom: 1px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--space-1);
            transition: all var(--transition-normal);
            border: 1px solid var(--border-light);
        }

        .task-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }



        .task-card .toggle {
            width: 32px;
            height: 18px;
            background: var(--text-muted);
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
            transition: background var(--transition-normal);
        }

        .task-card .toggle.on {
            background: var(--success);
        }

        .task-card .toggle::after {
            content: '';
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .task-card .toggle.on::after {
            left: 16px;
        }

        .task-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .task-comment {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 2px;
        }

        .task-schedule {
            font-weight: 600;
            font-size: 11px;
            color: var(--text-primary);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .task-name-row {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .task-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .task-name.editable {
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
        }

        .task-name:hover {
            opacity: 0.8;
        }

        .task-name-empty {
            color: var(--text-muted);
            font-style: italic;
            font-weight: 400;
        }

        .task-name-empty:hover {
            color: var(--primary);
        }

        .task-group-label {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            margin-left: var(--space-2);
            display: none;
            cursor: pointer;
        }

        .task-group-label:hover {
            color: var(--primary);
        }

        /* Active/Paused 模式下显示 group label */
        .task-list.flat-view .task-group-label {
            display: inline;
        }

        .task-command {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 2px var(--space-1);
            border-radius: var(--radius-sm);
            word-break: break-all;
            margin-top: 2px;
            border: 1px solid var(--border-light);
        }

        /* 原始编辑区域（在 History 内） */
        .raw-editor-section {
            margin-bottom: var(--space-5);
        }

        .code-editor {
            position: relative;
            height: 50vh;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-tertiary);
        }

        .code-editor.editing {
            background: var(--bg-secondary);
        }

        .code-editor.editing:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }

        .code-highlight,
        .code-editor textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: var(--space-3);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
            box-sizing: border-box;
        }

        .code-highlight {
            color: var(--text-primary);
            pointer-events: none;
            z-index: 1;
        }

        .code-editor textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--text-primary);
            border: none;
            outline: none;
            resize: none;
            z-index: 2;
        }

        /* 语法高亮颜色 */
        .hl-comment {
            color: #6a9955;
        }

        .hl-schedule {
            color: #b8860b;
        }

        .hl-command {
            color: #000;
        }

        .hl-env-key {
            color: #9cdcfe;
        }

        .hl-env-value {
            color: #ce9178;
        }

        .hl-disabled {
            color: #6a9955;
            font-style: italic;
        }

        .save-btn {
            margin-top: var(--space-4);
            padding: var(--space-3) var(--space-6);
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .save-btn:hover {
            background: var(--success-hover);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        .save-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 历史版本视图 */
        .history-view {
            display: none;
        }

        .history-view.active {
            display: block;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .history-header-btns {
            display: flex;
            gap: var(--space-2);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .history-item.expanded {
            flex-direction: column;
            align-items: stretch;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }

        .history-item:not(.expanded):hover {
            background: var(--bg-hover);
        }

        .history-time {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .history-user {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: var(--space-2);
            padding: 2px 8px 2px 4px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 11px;
            font-weight: 500;
            color: var(--primary);
        }

        .history-user svg {
            width: 12px;
            height: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-1);
            margin-top: var(--space-3);
            padding: var(--space-2) 0;
        }

        .pagination:empty {
            display: none;
        }

        .page-btn {
            min-width: 32px;
            height: 32px;
            padding: 0 var(--space-2);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0 var(--space-2);
        }

        .view-icon {
            color: var(--text-muted);
            font-size: 12px;
        }

        .history-content {
            margin-top: var(--space-2);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            background: var(--bg-tertiary);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            max-height: 400px;
            overflow: auto;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* 消息提示 */
        .message {
            position: fixed;
            top: var(--space-5);
            right: var(--space-5);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-md);
            color: white;
            display: none;
            z-index: 1000;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn var(--transition-normal) ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            background: var(--success);
            display: block;
        }

        .message.error {
            background: #ef4444;
            display: block;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-5);
        }

        .header h1 {
            margin-bottom: 0;
        }

        /* 内联编辑样式 */
        .task-schedule {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .editable {
            padding: 2px var(--space-1);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            border: 1px solid transparent;
            transition: all var(--transition-fast);
        }

        .editable:hover {
            background: rgba(74, 144, 217, 0.1);
            border-color: var(--primary);
        }

        .editable.time-field {
            min-width: 30px;
            text-align: center;
        }

        .editable.cmd-field {
            flex: 1;
            word-break: break-all;
        }

        .editable input {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            padding: 2px var(--space-1);
            border: 1px solid var(--primary);
            border-radius: var(--radius-sm);
            outline: none;
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }

        .editable input.time-input {
            width: 45px;
            text-align: center;
        }

        .editable input.cmd-input {
            width: 100%;
            min-width: 200px;
        }

        .task-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .detail-btn {
            width: 14px;
            height: 14px;
            background: var(--primary);
            border: 0.5px solid var(--primary-hover);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform var(--transition-fast);
        }

        .detail-btn:hover {
            transform: scale(1.2);
            background: var(--primary-hover);
        }

        .run-btn {
            width: 14px;
            height: 14px;
            background: var(--success);
            border: 0.5px solid var(--success-hover);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 7px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 1px;
            transition: transform var(--transition-fast);
        }

        .run-btn:hover {
            transform: scale(1.2);
            background: var(--success-hover);
        }

        .delete-btn {
            width: 14px;
            height: 14px;
            background: var(--danger);
            border: 0.5px solid var(--danger-border);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            font-size: 0;
            transition: transform var(--transition-fast);
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        .delete-btn::before,
        .delete-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 7px;
            height: 1.5px;
            background: transparent;
            transition: background var(--transition-fast);
        }

        .delete-btn::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .delete-btn::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .delete-btn:hover::before,
        .delete-btn:hover::after {
            background: #4D0000;
        }

        /* 无权限元素样式 */
        .no-permission {
            opacity: 0.3 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }
        .no-permission .toggle,
        .no-permission .group-toggle-switch {
            pointer-events: none !important;
        }

        /* 任务分组卡片 */
        .task-group {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .task-group .group-header {
            background: #f0f3f5;
            padding: 2px var(--space-2);
            min-height: 22px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            user-select: none;
            transition: background var(--transition-fast);
        }

        .task-group .group-header:hover {
            background: var(--bg-hover);
        }

        .group-delete-btn {
            margin-left: auto;
            width: 14px;
            height: 14px;
            background: var(--danger);
            border: 0.5px solid var(--danger-border);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            font-size: 0;
            transition: transform var(--transition-fast);
        }

        .group-delete-btn:hover {
            transform: scale(1.15);
        }

        .group-delete-btn::before,
        .group-delete-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 1.5px;
            background: transparent;
            transition: background var(--transition-fast);
        }

        .group-delete-btn::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .group-delete-btn::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .group-delete-btn:hover::before,
        .group-delete-btn:hover::after {
            background: #4D0000;
        }

        .task-group .group-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            padding: 1px var(--space-1);
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            transition: font-size var(--transition-normal), color var(--transition-normal);
        }

        .task-group.collapsed .group-title {
            font-size: 14px;
        }

        .task-group.disabled .group-title {
            color: var(--text-muted);
        }

        .task-group .group-title:hover {
            background: rgba(74, 144, 217, 0.1);
            border-color: var(--primary);
            cursor: text;
        }

        .task-group .group-title input {
            font-weight: 600;
            font-size: 13px;
            padding: 2px var(--space-1);
            border: 1px solid var(--primary);
            border-radius: var(--radius-sm);
            outline: none;
            background: var(--bg-secondary);
            width: 200px;
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }

        .task-group .group-count {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--border-color);
            padding: 2px var(--space-2);
            border-radius: 10px;
            font-weight: 500;
        }

        .task-group .group-toggle-switch {
            width: 36px;
            height: 20px;
            background: var(--text-muted);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            margin-right: var(--space-2);
            flex-shrink: 0;
            transition: background var(--transition-normal);
        }

        .task-group .group-toggle-switch.on {
            background: var(--success);
        }

        .task-group .group-toggle-switch.partial {
            background: var(--warning);
        }

        .task-group .group-toggle-switch::after {
            content: '';
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .task-group .group-toggle-switch.on::after {
            left: 18px;
        }

        .task-group .group-toggle-switch.partial::after {
            left: 9px;
        }

        .task-group .group-tasks {
            padding: 3px 4px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height var(--transition-slow), padding var(--transition-slow), opacity var(--transition-slow);
            opacity: 1;
        }

        .task-group.collapsed .group-tasks {
            max-height: 0;
            padding: 0 4px;
            opacity: 0;
        }

        .task-group .group-header {
            transition: border-bottom var(--transition-slow);
        }

        .task-group.collapsed .group-header {
            border-bottom: none;
        }

        .task-group .task-card {
            margin-bottom: var(--space-1);
            box-shadow: none;
            border: 1px solid var(--border-light);
        }

        .task-group .task-card:hover {
            background: #f1f5f9;
        }

        .task-group .task-card:last-child {
            margin-bottom: 0;
        }

        /* Flat View Mode */
        .task-list.flat-view {
            padding-top: var(--space-2);
        }

        .task-list.flat-view .task-group {
            background: transparent;
            border: none;
            box-shadow: none;
            margin-bottom: 0;
            border-radius: 0;
            overflow: visible;
        }

        .task-list.flat-view .group-header {
            display: none !important;
        }

        .task-list.flat-view .group-tasks {
            padding: 0;
            max-height: none !important;
            opacity: 1 !important;
            margin-top: 0;
            display: block !important;
        }

        .task-list.flat-view .task-card {
            margin-bottom: var(--space-1);
            box-shadow: none;
            border: 1px solid var(--border-color);
        }

        .task-list.flat-view .group-add-task-btn,
        .task-list.flat-view .group-add-form {
            display: none !important;
        }

        /* 折叠控制按钮 */
        .collapse-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, var(--bg-primary), var(--bg-primary) 90%, transparent);
            padding: var(--space-1) 0 var(--space-2) 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .collapse-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            width: 32px;
            padding: 0;
            background: var(--primary);
            border: 1px solid var(--primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: white;
            flex-shrink: 0;
            transition: all var(--transition-fast);
        }

        .collapse-toggle-btn:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .collapse-toggle-btn.all-collapsed {
            background: var(--success);
            border-color: var(--success);
        }

        .collapse-toggle-btn.all-collapsed:hover {
            background: #16a34a;
            border-color: #16a34a;
        }

        .collapse-toggle-btn .expand-icon {
            display: none;
        }

        .collapse-toggle-btn .collapse-icon {
            display: block;
        }

        .collapse-toggle-btn.all-collapsed .expand-icon {
            display: block;
        }

        .collapse-toggle-btn.all-collapsed .collapse-icon {
            display: none;
        }

        /* Active/Paused 模式下隐藏折叠按钮和 New Group */
        .collapse-controls.flat-mode .collapse-toggle-btn,
        .collapse-controls.flat-mode .new-group-btn {
            width: 0;
            padding: 0;
            margin: 0 calc(var(--space-2) * -0.5);
            border-color: transparent;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        /* 搜索框 */
        .search-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box {
            flex: 1;
            height: 32px;
            padding: 0 36px 0 var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .search-box::placeholder {
            color: var(--text-muted);
        }

        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }

        .case-toggle {
            position: absolute;
            right: 4px;
            height: 24px;
            padding: 0 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .case-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .case-toggle.active {
            background: var(--primary);
            color: white;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            align-items: center;
            height: 32px;
            background: var(--bg-tertiary);
            padding: 2px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .filter-btn {
            height: 100%;
            padding: 0 var(--space-3);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
        }

        .filter-btn:hover {
            color: var(--text-primary);
            background: #d9dce1;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* 按钮之间的分割线 */
        .filter-btn+.filter-btn {
            position: relative;
        }

        .filter-btn+.filter-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 20%;
            height: 60%;
            width: 1px;
            background: var(--border-color);
        }

        /* active/hover 按钮旁边不显示分割线 */
        .filter-btn.active+.filter-btn::before,
        .filter-btn+.filter-btn.active::before,
        .filter-btn:hover+.filter-btn::before,
        .filter-btn+.filter-btn:hover::before {
            display: none;
        }

        /* 新建任务组按钮 */
        .new-group-btn {
            height: 32px;
            padding: 0 var(--space-3);
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
        }

        .new-group-btn:hover {
            background: var(--success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .new-group-btn:active {
            transform: scale(0.95);
        }

        .plus-icon {
            font-size: 1.2em;
            font-weight: 700;
            line-height: 1;
        }

        /* 组内添加任务按钮 */
        .group-add-task-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px var(--space-2);
            margin-top: 2px;
            margin-bottom: var(--space-1);
            background: var(--bg-tertiary);
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .group-add-task-btn:hover {
            background: rgba(76, 175, 80, 0.1);
            border-color: var(--success);
            color: var(--success);
            transform: translateY(-1px);
        }

        .group-add-task-btn:active {
            transform: scale(0.98);
        }

        /* 组内添加任务表单 */
        .group-add-form {
            display: none;
            padding: var(--space-3);
            margin-top: var(--space-2);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            animation: fadeIn var(--transition-fast) ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .group-add-form.active {
            display: block;
        }

        .group-add-form .mini-name-input {
            width: 100%;
            padding: var(--space-2);
            margin-bottom: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .group-add-form .mini-name-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.15);
        }

        .group-add-form .mini-cron-inputs {
            display: flex;
            gap: var(--space-1);
            margin-bottom: var(--space-2);
        }

        .group-add-form .mini-cron-inputs input {
            width: 42px;
            padding: var(--space-1);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            text-align: center;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .group-add-form .mini-cron-inputs input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.15);
        }

        .group-add-form .mini-command-row {
            display: flex;
            gap: var(--space-2);
        }

        .group-add-form .mini-command-row input {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .group-add-form .mini-command-row input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.15);
        }

        .group-add-form .mini-add-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .group-add-form .mini-add-btn:hover {
            background: var(--success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .group-add-form .mini-add-btn:active {
            transform: scale(0.95);
        }

        .group-add-form .mini-cancel-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .group-add-form .mini-cancel-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* 新建任务组表单 */
        .new-group-form {
            display: none;
            padding: var(--space-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
            border: 1px solid var(--border-color);
            animation: fadeIn var(--transition-fast) ease-out;
        }

        .new-group-form.active {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .new-group-form input {
            flex: 1;
            padding: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .new-group-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 217, 0.15);
        }

        .new-group-form input::placeholder {
            color: var(--text-muted);
        }

        .new-group-form button {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .new-group-form .create-btn {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .new-group-form .create-btn:hover {
            background: var(--success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .new-group-form .create-btn:active {
            transform: scale(0.95);
        }

        .new-group-form .cancel-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .new-group-form .cancel-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* 响应式设计 */
        /* 平板适配 */
        @media (max-width: 768px) {
            body {
                padding: var(--space-3);
            }

            h1 {
                font-size: 22px;
            }

            .header {
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            .header .tabs {
                order: 3;
                width: 100%;
            }

            .host-selector {
                order: 2;
                width: 100%;
                margin-left: 0;
                padding-top: var(--space-2);
                border-top: 1px solid var(--border-color);
            }

            .collapse-controls {
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            .collapse-toggle-btn {
                flex: 1;
                justify-content: center;
            }

            .search-box {
                order: -1;
                flex: 1 1 100%;
                max-width: none;
            }

            .new-group-btn {
                flex: 1;
                justify-content: center;
            }

            .task-card {
                flex-wrap: wrap;
                padding: var(--space-3);
            }

            .task-info {
                min-width: 100%;
                order: 1;
                margin-top: var(--space-2);
            }

            .new-group-form {
                flex-wrap: wrap;
            }

            .new-group-form input {
                flex: 1 1 100%;
            }

            .new-group-form button {
                flex: 1;
            }

            .group-add-form .mini-cron-inputs {
                flex-wrap: wrap;
            }

            .group-add-form .mini-cron-inputs input {
                flex: 1;
                min-width: 36px;
            }

            .group-add-form .mini-command-row {
                flex-wrap: wrap;
            }

            .group-add-form .mini-command-row input {
                flex: 1 1 100%;
                margin-bottom: var(--space-2);
            }

            .task-group .group-header {
                padding: var(--space-3);
                min-height: 50px;
            }
        }

        /* 手机适配 */
        @media (max-width: 480px) {
            body {
                padding: var(--space-2);
            }

            h1 {
                font-size: 20px;
            }

            .header {
                flex-wrap: wrap;
                gap: var(--space-2);
            }

            .header h1 {
                order: 1;
            }

            .header .user-info {
                order: 2;
            }

            .header .tabs {
                order: 3;
                width: 100%;
                flex-wrap: wrap;
            }

            .tab {
                font-size: 13px;
            }

            .collapse-controls {
                gap: var(--space-1);
            }

            .collapse-toggle-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 12px;
            }

            .search-box {
                padding: var(--space-3);
                font-size: 14px;
            }

            .new-group-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 12px;
            }

            .task-group {
                margin-bottom: var(--space-3);
                border-radius: var(--radius-md);
            }

            .task-group .group-header {
                gap: var(--space-2);
                padding: var(--space-2) var(--space-3);
                min-height: 44px;
            }

            .task-group .group-title {
                font-size: 14px;
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .task-group .group-count {
                font-size: 10px;
                flex-shrink: 0;
            }

            .task-card {
                padding: var(--space-2);
                gap: var(--space-2);
                border-radius: var(--radius-sm);
            }

            .task-name {
                font-size: 14px;
            }

            .task-schedule {
                gap: var(--space-1);
            }

            .editable.time-field {
                min-width: 28px;
                font-size: 11px;
                padding: 4px 2px;
            }

            .task-command {
                font-size: 10px;
                padding: var(--space-1);
            }

            .message {
                left: var(--space-2);
                right: var(--space-2);
                top: auto;
                bottom: var(--space-5);
                text-align: center;
            }

            .log-entry {
                flex-wrap: wrap;
                gap: var(--space-1);
                padding: var(--space-2);
            }

            .log-time,
            .log-user,
            .log-action {
                min-width: auto;
                font-size: 11px;
            }

            .log-details {
                flex: 1 1 100%;
                font-size: 11px;
                margin-top: var(--space-1);
            }

            .group-add-form {
                padding: var(--space-2) !important;
            }

            .group-add-form .mini-cron-inputs input {
                min-width: 30px;
                padding: var(--space-2);
                font-size: 12px;
            }

            .group-add-task-btn {
                padding: var(--space-2) var(--space-3);
                font-size: 12px;
            }

            .cron-tooltip {
                font-size: 11px;
                padding: var(--space-1) var(--space-2);
            }

            /* 拖拽手柄增大触摸区域 */
            .drag-handle {
                padding: var(--space-3) var(--space-2);
                font-size: 16px;
                min-width: 32px;
                min-height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* 拖拽排序样式 - 拖影生成时的临时样式 */
        .task-group.dragging,
        .task-card.dragging {
            opacity: 0.2;
        }

        /* 拖影生成后隐藏原位置（占位符已在原位） */
        .task-group.dragging-collapsed,
        .task-card.dragging-collapsed {
            display: none !important;
        }

        /* 组拖拽目标指示器 */
        .task-group.drag-over {
            border: 2px dashed var(--primary);
            background: rgba(74, 144, 217, 0.08);
            box-shadow: inset 0 0 0 2px rgba(74, 144, 217, 0.1);
        }

        /* 任务拖拽占位符 - 真实 DOM 元素，会推开其他任务 */
        .drag-placeholder {
            border: 2px dashed var(--primary);
            border-radius: var(--radius-sm);
            background: rgba(74, 144, 217, 0.06);
            margin-bottom: var(--space-1);
            box-sizing: border-box;
            transition: height 0.15s ease-out;
            overflow: hidden;
        }

        /* 组拖拽占位符 */
        .drag-placeholder-group {
            border: 2px dashed var(--primary);
            border-radius: var(--radius-md);
            background: rgba(74, 144, 217, 0.06);
            margin-bottom: var(--space-3);
            box-sizing: border-box;
            transition: height 0.15s ease-out;
            overflow: hidden;
        }

        /* 组末尾放置区 - 与任务卡片等大 */
        .group-drop-end {
            height: 0;
            overflow: hidden;
            transition: all var(--transition-fast);
            border-radius: var(--radius-sm);
        }

        .group-drop-end.visible {
            height: 52px;
            border: 2px dashed var(--primary);
            background: rgba(74, 144, 217, 0.06);
            margin-top: var(--space-1);
        }

        .drag-handle {
            cursor: -webkit-grab;
            cursor: grab;
            padding: var(--space-2) var(--space-1);
            color: var(--text-muted);
            font-size: 14px;
            transition: color var(--transition-fast), background var(--transition-fast);
            user-select: none;
            border-radius: var(--radius-sm);
        }

        .drag-handle:hover {
            color: var(--text-secondary);
            background: var(--bg-hover);
        }

        .drag-handle:active {
            cursor: -webkit-grabbing;
            cursor: grabbing;
        }

        .task-card:not([draggable="true"]),
        .task-group:not([draggable="true"]) {
            cursor: default;
        }

        .group-drag-handle {
            margin-right: var(--space-2);
            overflow: hidden;
            transition: width 0.2s ease, opacity 0.2s ease, margin 0.2s ease;
        }

        /* 展开状态隐藏拖拽图标 */
        .task-group:not(.collapsed) .group-drag-handle {
            width: 0;
            margin-right: 0;
            opacity: 0;
        }

        /* Active/Paused 过滤视图下隐藏所有拖拽图标 */
        .flat-view .drag-handle {
            display: none;
        }

        /* Cron 时间预览 Tooltip */
        .cron-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: var(--text-primary);
            color: white;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: nowrap;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
            box-shadow: var(--shadow-lg);
        }

        .cron-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 16px;
            border: 6px solid transparent;
            border-top-color: var(--text-primary);
        }

        .task-schedule-wrapper {
            position: relative;
            display: inline-block;
            width: fit-content;
        }

        .task-schedule-wrapper:hover .cron-tooltip {
            opacity: 1;
        }

        .task-card:has(.task-schedule-wrapper:hover) {
            overflow: visible;
            z-index: 100;
        }

        .task-group:has(.task-schedule-wrapper:hover) {
            overflow: visible;
        }

        .group-tasks:has(.task-schedule-wrapper:hover) {
            overflow: visible;
        }

        /* 搜索高亮 */
        .search-highlight {
            background: var(--warning);
            color: var(--text-primary);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Undo 撤销提示条 */
        .undo-toast {
            position: fixed;
            bottom: var(--space-5);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            opacity: 0;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }

        .undo-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .undo-toast .undo-text {
            font-size: 14px;
        }

        .undo-toast .undo-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: background var(--transition-fast);
        }

        .undo-toast .undo-btn:hover {
            background: var(--primary-hover);
        }

        .undo-toast .undo-timer {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .undo-toast .undo-countdown {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 版本对比弹窗 */
        .diff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .diff-modal.show {
            display: flex;
        }

        .diff-modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .diff-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 16px;
        }

        .diff-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
        }

        .diff-close-btn:hover {
            color: var(--danger);
        }

        .diff-modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: var(--space-2);
            padding: var(--space-4);
        }

        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .diff-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            background: var(--bg-tertiary);
            font-weight: 500;
            font-size: 13px;
            color: var(--text-secondary);
            overflow: hidden;
        }

        .diff-panel-header > span {
            display: flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
        }

        .diff-nav-btn {
            background: var(--primary);
            border: none;
            width: 48px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .diff-nav-btn:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .diff-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .diff-nav-placeholder {
            width: 48px;
        }

        /* Diff 标题切换动画 */
        .diff-title-slide {
            display: inline-block;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .diff-title-slide.slide-left {
            animation: slideLeft 0.3s ease;
        }

        .diff-title-slide.slide-right {
            animation: slideRight 0.3s ease;
        }

        @keyframes slideLeft {
            0% { transform: translateX(20px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideRight {
            0% { transform: translateX(-20px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .diff-content {
            flex: 1;
            margin: 0;
            padding: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            overflow: auto;
            overscroll-behavior: contain;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .diff-line {
            padding: 0 var(--space-3);
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 1.6em;
        }

        .diff-line.diff-add {
            background: rgba(46, 160, 67, 0.2);
        }

        .diff-line.diff-remove {
            background: rgba(248, 81, 73, 0.2);
        }

        .diff-line.diff-empty {
            background: var(--bg-tertiary);
        }

        /* 历史记录操作按钮 */
        .history-actions {
            display: flex;
            gap: var(--space-2);
        }

        .history-btn {
            padding: 4px 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .history-btn.diff-btn {
            background: var(--primary);
            color: white;
        }

        .history-btn.diff-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .history-btn.diff-btn:active {
            transform: scale(0.95);
        }

        .history-btn.save-mode {
            background: var(--success);
        }

        .history-btn.save-mode:hover {
            background: var(--success-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .history-btn.save-mode:active {
            transform: scale(0.95);
        }

        .history-btn.cancel-edit-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .history-btn.cancel-edit-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .history-btn.restore-btn {
            background: var(--warning);
            color: var(--text-primary);
        }

        .history-btn.restore-btn:hover {
            background: #e0a800;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .history-btn.restore-btn:active {
            transform: scale(0.95);
        }

        /* 帮助按钮和面板样式 */
        .help-toggle-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #fff9d6, #ffe066);
            color: #cc9900;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(204, 153, 0, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .help-toggle-btn:hover {
            background: linear-gradient(145deg, #ffe066, #ffd700);
            box-shadow: 0 2px 6px rgba(204, 153, 0, 0.4);
            transform: scale(1.1);
        }

        .help-toggle-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
        }

        .edit-help-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin: 8px 0;
            padding: 12px 16px;
            font-size: 13px;
        }

        .help-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .help-example {
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .help-example:last-child {
            margin-bottom: 0;
        }

        .help-example code {
            display: block;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .help-desc {
            display: block;
            margin-top: 4px;
            color: var(--text-muted);
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Crontab Manager</h1>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">Task List</button>
            <button class="tab" onclick="switchTab('history')">Raw Version</button>
            <button class="tab" onclick="switchTab('cron')">Cron Logs</button>
            <button class="tab" onclick="switchTab('logs')">Audit Logs</button>
        </div>
        <div class="host-selector">
            <div class="selector-group">
                <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></label>
                <select id="machineSelect" onchange="switchMachine(this.value)">
                </select>
            </div>
            <div class="connection-status" title="Connection status">
                <span class="status-dot" id="connectionStatus"></span>
            </div>
        </div>
        <div class="user-info" id="userMenu">
            <span class="user-name">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="7" r="4" />
                    <path d="M5.5 21a6.5 6.5 0 0 1 13 0z" />
                </svg>
                <strong>{{ username }}</strong>
                <svg class="dropdown-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </span>
            <div class="user-dropdown">
                {% if user_role == 'admin' %}
                <div class="user-dropdown-item" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
                <div class="user-dropdown-divider"></div>
                {% endif %}
                <a href="/logout" class="user-dropdown-item danger">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </div>

    <div class="collapse-controls">
        <div class="filter-controls">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-btn" data-filter="active" onclick="setFilter('active')">Active</button>
            <button class="filter-btn" data-filter="paused" onclick="setFilter('paused')">Paused</button>
        </div>
        <button class="collapse-toggle-btn" id="collapseToggleBtn" onclick="toggleAllGroups()" title="Expand All">
            <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 10l5 5 5-5" />
                <path d="M7 5l5 5 5-5" />
            </svg>
            <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M7 14l5-5 5 5" />
                <path d="M7 19l5-5 5 5" />
            </svg>
        </button>
        <div class="search-wrapper">
            <input type="text" class="search-box" id="searchBox" placeholder="Search group names or task names..."
                oninput="taskCurrentPage=1; filterTasks()">
            <button class="case-toggle" id="caseToggle" onclick="toggleCaseSensitive()"
                title="Case Sensitive">Aa</button>
        </div>
        <button class="new-group-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="showNewGroupForm()"{% endif %}><span class="plus-icon">+</span> New Group</button>
    </div>

    <div id="newGroupForm" class="new-group-form">
        <input type="text" id="newGroupTitle" placeholder="Enter group name">
        <button class="create-btn" onclick="createGroup()">Create</button>
        <button class="cancel-btn" onclick="hideNewGroupForm()">Cancel</button>
    </div>

    <div id="taskList" class="task-list active"></div>
    <div class="pagination" id="taskPagination"></div>

    <div id="historyView" class="history-view">
        <div class="history-header">
            <span>Current Version</span>
            <div class="history-header-btns">
                <button class="help-toggle-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditHelp()"{% endif %} id="editHelpBtn" title="Syntax Help">?</button>
                <button class="history-btn diff-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="toggleEditMode()"{% endif %} id="editToggleBtn">Edit</button>
                <button class="history-btn cancel-edit-btn{% if user_role == 'viewer' %} no-permission{% endif %}" {% if user_role != 'viewer' %}onclick="cancelEditMode()"{% endif %} id="cancelEditBtn"
                    style="display: none;">Cancel</button>
            </div>
        </div>
        <div class="edit-help-panel" id="editHelpPanel" style="display: none;">
            <div class="help-content">
                <div class="help-title">📝 Edit 编辑语法</div>
                <div class="help-example">
                    <span class="help-desc">1. 创建新组并添加任务</span>
                    <code></code>
                    <code>  ←空行</code>
                    <code># 新组名称</code>
                    <code># 任务名称（可选）</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">→ 空行 + 注释行 + 任务行</span>
                </div>
                <div class="help-example">
                    <span class="help-desc">2. 在已有任务的任务组内添加任务</span>
                    <code>... 组内其他任务 ...</code>
                    <code># 任务名称（可选）</code>
                    <code>* * * * * /path/to/command</code>
                    <span class="help-desc">→ 紧跟在组内最后一个任务后添加，无空行</span>
                </div>
            </div>
        </div>
        <div class="raw-editor-section" id="rawEditorSection">
            <div class="code-editor">
                <pre class="code-highlight" id="codeHighlight"></pre>
                <textarea id="rawContent" oninput="updateHighlight()" onscroll="syncHighlightScroll()"
                    readonly></textarea>
            </div>
        </div>

        <div class="history-header">
            <span>History Version</span>
        </div>
        <div class="history-list" id="historyList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="historyPagination"></div>
    </div>

    <div id="cronLogs" class="cron-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="cronLogSource">-</code></span>
            <button class="refresh-btn" onclick="loadCronLogs()" title="Refresh">⟳</button>
        </div>
        <input type="text" id="cronSearch" class="audit-search" placeholder="Search logs..." oninput="filterCronLogs()">
        <div class="log-header">
            <span class="cron-col-time">Time</span>
            <span class="cron-col-host">Host</span>
            <span class="cron-col-details">Details</span>
        </div>
        <div class="cron-log-list" id="cronLogList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="cronPagination"></div>
    </div>

    <div id="auditLogs" class="audit-logs">
        <div class="cron-log-header">
            <span class="cron-log-source">Source: <code id="auditLogSource">-</code></span>
        </div>
        <input type="text" id="auditSearch" class="audit-search" placeholder="Search logs..." oninput="filterAuditLogs()">
        <div class="log-header">
            <span class="log-col-time">Time</span>
            <span class="log-col-user">
                User
                <span class="col-filter" onclick="toggleFilterDropdown('user')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="userFilterDropdown"></div>
            </span>
            <span class="log-col-action">
                Action
                <span class="col-filter" onclick="toggleFilterDropdown('action')"><svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg></span>
                <div class="filter-dropdown" id="actionFilterDropdown"></div>
            </span>
            <span class="log-col-details">Details</span>
        </div>
        <div class="log-list" id="logList">
            <div class="log-empty">Loading...</div>
        </div>
        <div class="pagination" id="auditPagination"></div>
    </div>

    <!-- Settings Tab (仅 admin 可见) -->
    {% if user_role == 'admin' %}
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-section">
            <h3>User Management</h3>
            <div class="user-form">
                <input type="text" id="newUsername" placeholder="Username">
                <input type="password" id="newPassword" placeholder="Password">
                <select id="newRole">
                    <option value="viewer">Viewer</option>
                    <option value="editor">Editor</option>
                    <option value="admin">Admin</option>
                </select>
                <button class="add-user-btn" onclick="createUser()">Add User</button>
            </div>
            <div class="user-list" id="userList">
                <div class="log-empty">Loading...</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="message" class="message"></div>

    <!-- Undo 撤销提示条 -->
    <div id="undoToast" class="undo-toast">
        <span class="undo-text">Task deleted</span>
        <button class="undo-btn" onclick="performUndo()">Undo</button>
        <span class="undo-countdown">5s</span>
    </div>

    <!-- 版本对比弹窗 -->
    <div id="diffModal" class="diff-modal">
        <div class="diff-modal-content">
            <div class="diff-modal-header">
                <span>Version Diff</span>
                <button class="diff-close-btn" onclick="closeDiffModal()">&times;</button>
            </div>
            <div class="diff-modal-body">
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <button class="diff-nav-btn" id="diffPrevBtn" onclick="navigateDiff(-1)" title="Previous version">‹</button>
                        <span>Backup: <span id="diffBackupTime" class="diff-title-slide"></span></span>
                        <button class="diff-nav-btn" id="diffNextBtn" onclick="navigateDiff(1)" title="Next version">›</button>
                    </div>
                    <pre class="diff-content" id="diffBackup"></pre>
                </div>
                <div class="diff-panel">
                    <div class="diff-panel-header">
                        <span class="diff-nav-placeholder"></span>
                        <span>Current</span>
                        <span class="diff-nav-placeholder"></span>
                    </div>
                    <pre class="diff-content" id="diffCurrent"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 全局变量 ==========
        let groups = [];
        let undoStack = [];      // 撤销栈
        let undoTimer = null;
        let undoCountdown = 5;
        // 拖拽状态
        let draggedElement = null;
        let dragType = null;         // 'group' or 'task'
        let dragRafId = null;        // requestAnimationFrame ID，用于节流
        let lastDragOverTarget = null;
        let isDragging = false;
        let dragPlaceholder = null;  // 拖拽占位符元素
        // 机器管理
        let machines = {};           // 机器配置
        let currentMachine = 'local';
        let currentLinuxUser = 'root';  // 默认用户为 root
        const collapsedStateMap = new Map();  // 保存每个 machine+user 的折叠状态
        // 权限管理（服务端渲染）
        const USER_ROLE = '{{ user_role }}';
        const USER_CAN_EDIT = USER_ROLE === 'editor' || USER_ROLE === 'admin';
        const USER_CAN_ADMIN = USER_ROLE === 'admin';

        // ========== SVG 图标常量 ==========
        const ICON = {
            // 用户图标（实心）
            USER: '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0z"/></svg>',
            // 主机图标（显示器）
            HOST: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>',
            // 过滤器图标
            FILTER: '<svg width="10" height="10" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2h14l-5.5 6v5l-3 2v-7L1 2z"/></svg>',
        };

        // ========== 工具函数 ==========
        // Cron 时间解析为人类可读描述
        function parseCronToHuman(minute, hour, day, month, weekday) {
            const weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // 解析单个字段
            function parseField(val, names = null) {
                if (val === '*') return null;
                if (val.startsWith('*/')) {
                    return `every ${val.slice(2)}`;
                }
                if (val.includes(',')) {
                    const vals = val.split(',').map(v => names ? (names[parseInt(v)] || v) : v);
                    return vals.join(', ');
                }
                if (val.includes('-')) {
                    const [start, end] = val.split('-');
                    if (names) return `${names[parseInt(start)] || start}-${names[parseInt(end)] || end}`;
                    return `${start}-${end}`;
                }
                return names ? (names[parseInt(val)] || val) : val;
            }

            // 格式化时间
            function formatTime(m, h) {
                if (m === '*' && h === '*') return 'every minute';
                if (m.startsWith('*/') && h === '*') return `every ${m.slice(2)} minutes`;
                if (m === '0' && h === '*') return 'every hour at :00';
                if (m === '30' && h === '*') return 'every hour at :30';
                if (m === '*' && h.startsWith('*/')) return `every minute, every ${h.slice(2)} hours`;
                if (m === '0' && h.startsWith('*/')) return `every ${h.slice(2)} hours`;

                const minPart = parseField(m);
                const hourPart = parseField(h);

                if (minPart === null && hourPart === null) return 'every minute';
                if (minPart !== null && hourPart === null) return `at minute ${minPart}`;
                if (minPart === null && hourPart !== null) return `every minute at hour ${hourPart}`;

                // 具体时间
                if (!m.includes('/') && !m.includes(',') && !m.includes('-') &&
                    !h.includes('/') && !h.includes(',') && !h.includes('-')) {
                    const hh = h.padStart(2, '0');
                    const mm = m.padStart(2, '0');
                    return `at ${hh}:${mm}`;
                }

                return `hour ${hourPart}, minute ${minPart}`;
            }

            let parts = [];

            // 时间部分
            parts.push(formatTime(minute, hour));

            // 日期部分
            const dayPart = parseField(day);
            const monthPart = parseField(month, monthNames);
            if (dayPart !== null && monthPart !== null) {
                parts.push(`on ${monthPart} ${dayPart}`);
            } else if (dayPart !== null) {
                parts.push(`on day ${dayPart}`);
            } else if (monthPart !== null) {
                parts.push(`in ${monthPart}`);
            }

            // 星期部分
            const weekdayPart = parseField(weekday, weekdayNames);
            if (weekdayPart !== null) {
                parts.push(`on ${weekdayPart}`);
            }

            return parts.join(', ').replace(/^./, c => c.toUpperCase());
        }

        // 高亮搜索关键词
        function highlightText(text, keyword) {
            if (!keyword) return escapeHtml(text);
            const escaped = escapeHtml(text);
            const flags = caseSensitive ? 'g' : 'gi';
            const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, flags);
            return escaped.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // 通用 API 调用封装
        async function apiCall(url, options = {}) {
            // 自动添加机器参数
            const bodyData = options.body || {};
            bodyData.machine_id = currentMachine;
            bodyData.linux_user = currentLinuxUser || 'root';
            const resp = await fetch(url, {
                method: options.method || 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            const result = await resp.json();
            if (result.success) {
                if (options.successMsg) showMessage(options.successMsg, 'success');
                if (options.reload !== false) loadTasksKeepState();
            } else {
                showMessage((options.errorPrefix || 'Error') + ': ' + result.error, 'error');
            }
            return result;
        }

        // 通用分页渲染函数
        function renderPagination(config) {
            const { elementId, currentPage, totalPages, goPageFn, totalItems, itemType, showDisplay } = config;
            const pagination = document.getElementById(elementId);
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                if (showDisplay !== undefined) pagination.style.display = 'none';
                return;
            }
            if (showDisplay !== undefined) pagination.style.display = 'flex';

            let html = '';
            html += `<button class="page-btn" onclick="${goPageFn}(1)" ${currentPage === 1 ? 'disabled' : ''}>«</button>`;
            html += `<button class="page-btn" onclick="${goPageFn}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>`;

            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="${goPageFn}(1)">1</button>`;
                if (startPage > 2) html += `<span class="page-info">...</span>`;
            }
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="${goPageFn}(${i})">${i}</button>`;
            }
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span class="page-info">...</span>`;
                html += `<button class="page-btn" onclick="${goPageFn}(${totalPages})">${totalPages}</button>`;
            }

            html += `<button class="page-btn" onclick="${goPageFn}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>`;
            html += `<button class="page-btn" onclick="${goPageFn}(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>»</button>`;
            if (totalItems !== undefined) html += `<span class="page-info">${totalItems} ${itemType || 'items'}</span>`;

            pagination.innerHTML = html;
        }

        // ========== UI 反馈（消息提示、撤销） ==========

        // 显示撤销提示
        function showUndoToast(message, undoData) {
            undoStack.push(undoData);
            const toast = document.getElementById('undoToast');
            toast.querySelector('.undo-text').textContent = message;
            toast.classList.add('show');

            undoCountdown = 5;
            updateUndoCountdown();

            if (undoTimer) clearInterval(undoTimer);
            undoTimer = setInterval(() => {
                undoCountdown--;
                updateUndoCountdown();
                if (undoCountdown <= 0) {
                    hideUndoToast();
                    undoStack.pop(); // 超时则移除撤销数据
                }
            }, 1000);
        }

        function updateUndoCountdown() {
            document.querySelector('.undo-countdown').textContent = `${undoCountdown}s`;
        }

        function hideUndoToast() {
            document.getElementById('undoToast').classList.remove('show');
            if (undoTimer) {
                clearInterval(undoTimer);
                undoTimer = null;
            }
        }

        // 执行撤销
        async function performUndo() {
            if (undoStack.length === 0) return;

            const undoData = undoStack.pop();
            hideUndoToast();

            if (undoData.type === 'delete_task') {
                // 恢复删除的任务
                const resp = await fetch(`/api/add_to_group/${undoData.groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule: undoData.schedule,
                        command: undoData.command,
                        enabled: undoData.enabled,
                        machine_id: currentMachine,
                        linux_user: currentLinuxUser || 'root'
                    })
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage('Task restored', 'success');
                    loadTasksKeepState();
                } else {
                    showMessage('Restore failed: ' + result.error, 'error');
                }
            } else if (undoData.type === 'delete_group') {
                // 恢复删除的任务组（需要后端支持）
                showMessage('Group restore not yet supported', 'error');
            }
        }

        // ========== 标签页切换 ==========

        function switchTab(tab) {
            // 检查是否处于编辑模式，如果是则阻止切换
            const textarea = document.getElementById('rawContent');
            if (textarea && !textarea.readOnly && tab !== 'history') {
                alert('Please save or cancel your changes before switching tabs.');
                return;
            }

            // 更新 tab 按钮状态（settings 不在 tab 栏中）
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabMap = { 'list': 1, 'history': 2, 'cron': 3, 'logs': 4 };
            if (tabMap[tab]) {
                document.querySelector(`.tab:nth-child(${tabMap[tab]})`).classList.add('active');
            }

            document.getElementById('taskList').classList.toggle('active', tab === 'list');
            document.getElementById('historyView').classList.toggle('active', tab === 'history');
            document.getElementById('cronLogs').classList.toggle('active', tab === 'cron');
            document.getElementById('auditLogs').classList.toggle('active', tab === 'logs');
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel) settingsPanel.classList.toggle('active', tab === 'settings');
            document.querySelector('.collapse-controls').style.display = tab === 'list' ? 'flex' : 'none';
            // 非 Task list 时隐藏分页栏；Task list 时由 renderTaskPagination 控制显示
            if (tab !== 'list') {
                document.getElementById('taskPagination').style.display = 'none';
            }
            document.getElementById('newGroupForm').classList.remove('active');
            document.getElementById('searchBox').value = '';

            if (tab === 'list') {
                loadTasksKeepState();
            } else if (tab === 'history') {
                loadRaw();
                loadHistory();
            } else if (tab === 'cron') {
                loadCronLogs();
            } else if (tab === 'logs') {
                loadAuditLogs();
            } else if (tab === 'settings') {
                loadUsers();
            }
        }

        // ========== 历史版本相关 ==========

        function toggleEditHelp() {
            const panel = document.getElementById('editHelpPanel');
            const btn = document.getElementById('editHelpBtn');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.classList.add('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        async function toggleEditMode() {
            const textarea = document.getElementById('rawContent');
            const btn = document.getElementById('editToggleBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const codeEditor = textarea.closest('.code-editor');
            const isEditing = !textarea.readOnly;

            if (isEditing) {
                // 保存模式 -> 只读模式
                await saveRaw();
                loadHistory(); // 保存后自动刷新历史版本
                textarea.readOnly = true;
                btn.textContent = 'Edit';
                btn.classList.remove('save-mode');
                cancelBtn.style.display = 'none';
                codeEditor.classList.remove('editing');
            } else {
                // 只读模式 -> 编辑模式
                textarea.readOnly = false;
                textarea.focus();
                btn.textContent = 'Save';
                btn.classList.add('save-mode');
                cancelBtn.style.display = 'inline-flex';
                codeEditor.classList.add('editing');
            }
        }

        function cancelEditMode() {
            const textarea = document.getElementById('rawContent');
            const btn = document.getElementById('editToggleBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const codeEditor = textarea.closest('.code-editor');

            // 恢复原始内容
            loadRaw();
            // 切换回只读模式
            textarea.readOnly = true;
            btn.textContent = 'Edit';
            btn.classList.remove('save-mode');
            cancelBtn.style.display = 'none';
            codeEditor.classList.remove('editing');
        }

        // 历史版本分页
        let historyBackups = [];
        let historyCurrentPage = 1;
        let currentDiffBackupIndex = -1;  // 当前 diff 显示的备份索引
        const HISTORY_ROW_HEIGHT = 38; // 每行高度(px): padding 8 + content 24 + border 2 + gap 4
        const HISTORY_MIN_PAGE_SIZE = 10;

        let allAuditLogs = [];  // 原始日志数据
        let auditLogs = [];     // 过滤后的日志
        let auditCurrentPage = 1;
        let activeUserFilter = null;
        let activeActionFilter = null;
        const AUDIT_ROW_HEIGHT = 35; // 每行高度(px)
        const AUDIT_MIN_PAGE_SIZE = 10;

        let allCronLogs = [];   // 原始日志数据
        let cronLogs = [];      // 过滤后的日志
        let cronCurrentPage = 1;
        const CRON_ROW_HEIGHT = 35; // 每行高度(px)
        const CRON_MIN_PAGE_SIZE = 15;

        const PAGE_HEADER_OFFSET = 320; // 页头+tabs+搜索框+表头+分页栏等固定高度

        function getHistoryPageSize() {
            const availableHeight = window.innerHeight - PAGE_HEADER_OFFSET;
            const rows = Math.floor(availableHeight / HISTORY_ROW_HEIGHT);
            return Math.max(HISTORY_MIN_PAGE_SIZE, rows);
        }

        function getAuditPageSize() {
            const availableHeight = window.innerHeight - PAGE_HEADER_OFFSET;
            const rows = Math.floor(availableHeight / AUDIT_ROW_HEIGHT);
            return Math.max(AUDIT_MIN_PAGE_SIZE, rows);
        }

        function getCronPageSize() {
            const availableHeight = window.innerHeight - PAGE_HEADER_OFFSET;
            const rows = Math.floor(availableHeight / CRON_ROW_HEIGHT);
            return Math.max(CRON_MIN_PAGE_SIZE, rows);
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            const pagination = document.getElementById('historyPagination');
            try {
                const resp = await fetch(getApiPath('/api/backups'));
                const data = await resp.json();

                if (!data.backups?.length) {
                    list.innerHTML = '<div class="log-empty">No backups found</div>';
                    pagination.innerHTML = '';
                    return;
                }

                historyBackups = data.backups;
                historyCurrentPage = 1;
                renderHistoryPage();
            } catch (e) {
                list.innerHTML = '<div class="log-empty">Failed to load backups</div>';
                pagination.innerHTML = '';
            }
        }

        function renderHistoryPage() {
            const list = document.getElementById('historyList');
            const pageSize = getHistoryPageSize();
            const totalPages = Math.ceil(historyBackups.length / pageSize);
            if (historyCurrentPage > totalPages) historyCurrentPage = Math.max(1, totalPages);
            const start = (historyCurrentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageBackups = historyBackups.slice(start, end);

            list.innerHTML = pageBackups.map(b => {
                // 格式化时间：20251231_151544 -> 2025-12-31 15:15:44
                const ts = b.timestamp.replace(/_/, ' ').replace(/(\d{4})(\d{2})(\d{2}) (\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5:$6');
                const userLabel = b.username ? `<span class="history-user">${ICON.USER}${escapeHtml(b.username)}</span>` : '';
                return `<div class="history-item">
                    <div class="history-item-header" onclick="toggleHistoryItem(this.parentElement, '${b.filename}')">
                        <span class="history-time">${ts}${userLabel}</span>
                        <div class="history-actions">
                            <button class="history-btn diff-btn" onclick="event.stopPropagation(); showDiff('${b.filename}', '${ts}')">Diff</button>
                            <button class="history-btn restore-btn" onclick="event.stopPropagation(); restoreBackup('${b.filename}', '${ts}')">Restore</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            renderHistoryPagination(totalPages);
        }

        function renderHistoryPagination(totalPages) {
            renderPagination({
                elementId: 'historyPagination',
                currentPage: historyCurrentPage,
                totalPages,
                goPageFn: 'goHistoryPage',
                totalItems: historyBackups.length
            });
        }

        function goHistoryPage(page) {
            const pageSize = getHistoryPageSize();
            const totalPages = Math.ceil(historyBackups.length / pageSize);
            if (page < 1 || page > totalPages) return;
            historyCurrentPage = page;
            renderHistoryPage();
        }

        async function toggleHistoryItem(el, filename) {
            if (el.classList.contains('expanded')) {
                el.classList.remove('expanded');
                el.querySelector('.history-content')?.remove();
                return;
            }

            try {
                const resp = await fetch(getApiPath('/api/backup') + `/${encodeURIComponent(filename)}`);
                const data = await resp.json();
                if (data.content) {
                    el.classList.add('expanded');
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'history-content';
                    // 应用语法高亮
                    const lines = data.content.split('\n');
                    contentDiv.innerHTML = lines.map(line => `<div>${highlightLine(line)}</div>`).join('');
                    el.appendChild(contentDiv);
                }
            } catch (e) {
                showMessage('Failed to load backup content', 'error');
            }
        }

        // LCS diff 算法
        function computeDiff(oldLines, newLines) {
            const m = oldLines.length, n = newLines.length;
            // 构建 LCS 表
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (oldLines[i - 1] === newLines[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }
            // 回溯生成 diff
            const result = [];
            let i = m, j = n;
            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && oldLines[i - 1] === newLines[j - 1]) {
                    result.unshift({ type: 'same', oldLine: oldLines[i - 1], newLine: newLines[j - 1] });
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    result.unshift({ type: 'add', oldLine: null, newLine: newLines[j - 1] });
                    j--;
                } else {
                    result.unshift({ type: 'remove', oldLine: oldLines[i - 1], newLine: null });
                    i--;
                }
            }
            return result;
        }

        async function showDiff(filename, timestamp) {
            try {
                // 查找当前备份索引
                currentDiffBackupIndex = historyBackups.findIndex(b => b.filename === filename);

                // 获取当前版本和备份版本
                const [currentResp, backupResp] = await Promise.all([
                    fetch(getApiPath('/api/raw')),
                    fetch(getApiPath('/api/backup') + `/${encodeURIComponent(filename)}`)
                ]);
                const currentData = await currentResp.json();
                const backupData = await backupResp.json();

                const currentLines = (currentData.content || '').split('\n');
                const backupLines = (backupData.content || '').split('\n');

                // 使用 LCS diff 算法
                const diff = computeDiff(backupLines, currentLines);
                let currentHtml = '', backupHtml = '';

                for (const d of diff) {
                    if (d.type === 'same') {
                        currentHtml += `<div class="diff-line">${highlightLine(d.newLine)}</div>`;
                        backupHtml += `<div class="diff-line">${highlightLine(d.oldLine)}</div>`;
                    } else if (d.type === 'add') {
                        currentHtml += `<div class="diff-line diff-add">${highlightLine(d.newLine)}</div>`;
                        backupHtml += `<div class="diff-line diff-empty"></div>`;
                    } else if (d.type === 'remove') {
                        currentHtml += `<div class="diff-line diff-empty"></div>`;
                        backupHtml += `<div class="diff-line diff-remove">${highlightLine(d.oldLine)}</div>`;
                    }
                }

                document.getElementById('diffCurrent').innerHTML = currentHtml;
                document.getElementById('diffBackup').innerHTML = backupHtml;
                document.getElementById('diffBackupTime').textContent = timestamp;
                document.getElementById('diffModal').classList.add('show');

                // 更新导航按钮状态
                updateDiffNavButtons();

                // 设置同步滚动
                setupSyncScroll();
            } catch (e) {
                showMessage('Failed to load diff', 'error');
            }
        }

        // 更新 diff 导航按钮状态
        function updateDiffNavButtons() {
            const prevBtn = document.getElementById('diffPrevBtn');
            const nextBtn = document.getElementById('diffNextBtn');
            // 索引越小 = 越新，索引越大 = 越旧
            // prev 按钮：切换到更旧的版本（索引+1）
            // next 按钮：切换到更新的版本（索引-1）
            prevBtn.disabled = currentDiffBackupIndex >= historyBackups.length - 1;
            nextBtn.disabled = currentDiffBackupIndex <= 0;
        }

        // 导航到上一个/下一个备份版本
        async function navigateDiff(direction) {
            // direction: -1 = 更旧的版本（索引+1），1 = 更新的版本（索引-1）
            const newIndex = currentDiffBackupIndex - direction;
            if (newIndex < 0 || newIndex >= historyBackups.length) return;

            // 添加滑动动画
            const titleEl = document.getElementById('diffBackupTime');
            titleEl.classList.remove('slide-left', 'slide-right');
            // 触发重排以重新启动动画
            void titleEl.offsetWidth;
            titleEl.classList.add(direction === 1 ? 'slide-left' : 'slide-right');

            const backup = historyBackups[newIndex];
            const ts = backup.timestamp.replace(/_/, ' ').replace(/(\d{4})(\d{2})(\d{2}) (\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5:$6');
            await showDiff(backup.filename, ts);
        }

        function setupSyncScroll() {
            const panel1 = document.getElementById('diffCurrent');
            const panel2 = document.getElementById('diffBackup');
            let isSyncing = false;

            const syncScroll = (source, target) => {
                if (isSyncing) return;
                isSyncing = true;
                target.scrollTop = source.scrollTop;
                target.scrollLeft = source.scrollLeft;
                isSyncing = false;
            };

            panel1.onscroll = () => syncScroll(panel1, panel2);
            panel2.onscroll = () => syncScroll(panel2, panel1);
        }

        function closeDiffModal() {
            document.getElementById('diffModal').classList.remove('show');
        }

        async function restoreBackup(filename, timestamp) {
            if (!confirm(`Restore to backup: ${timestamp}?`)) return;

            try {
                const resp = await fetch(getApiPath('/api/restore') + `/${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await resp.json();
                if (data.success) {
                    showMessage('Restored successfully', 'success');
                    loadRaw();
                    loadHistory();
                } else {
                    showMessage(data.error || 'Restore failed', 'error');
                }
            } catch (e) {
                showMessage('Restore failed', 'error');
            }
        }

        // 点击弹窗外部关闭
        document.getElementById('diffModal').addEventListener('click', function (e) {
            if (e.target === this) closeDiffModal();
        });

        // ========== 日志相关 ==========

        async function loadAuditLogs() {
            const logList = document.getElementById('logList');
            const pagination = document.getElementById('auditPagination');
            const sourceEl = document.getElementById('auditLogSource');
            document.getElementById('auditSearch').value = '';
            activeUserFilter = null;
            activeActionFilter = null;

            try {
                const resp = await fetch(`/api/audit_logs/${encodeURIComponent(currentMachine)}`);
                const data = await resp.json();
                const logs = data.logs || [];

                // 更新 Source 显示
                sourceEl.textContent = data.path || '-';

                if (logs.length === 0) {
                    logList.innerHTML = '<div class="log-empty">No audit logs</div>';
                    pagination.innerHTML = '';
                    allAuditLogs = [];
                    auditLogs = [];
                    return;
                }

                allAuditLogs = logs;
                auditLogs = logs;
                auditCurrentPage = 1;
                renderAuditFilters();
                renderAuditPage();
            } catch (e) {
                logList.innerHTML = '<div class="log-empty">Failed to load</div>';
                pagination.innerHTML = '';
            }
        }

        function renderAuditFilters() {
            const users = [...new Set(allAuditLogs.map(l => l.user))].sort();
            const actions = [...new Set(allAuditLogs.map(l => l.action))].sort();

            const userDropdown = document.getElementById('userFilterDropdown');
            const actionDropdown = document.getElementById('actionFilterDropdown');

            userDropdown.innerHTML = `<div class="filter-option clear" onclick="selectFilter('user', null)">All</div>` +
                users.map(u => `<div class="filter-option${activeUserFilter === u ? ' active' : ''}" onclick="selectFilter('user', '${u}')">${u}</div>`).join('');

            actionDropdown.innerHTML = `<div class="filter-option clear" onclick="selectFilter('action', null)">All</div>` +
                actions.map(a => `<div class="filter-option${activeActionFilter === a ? ' active' : ''}" onclick="selectFilter('action', '${a}')">${a}</div>`).join('');

            // 更新过滤按钮状态
            document.querySelectorAll('.log-col-user .col-filter')[0]?.classList.toggle('active', !!activeUserFilter);
            document.querySelectorAll('.log-col-action .col-filter')[0]?.classList.toggle('active', !!activeActionFilter);
        }

        function toggleFilterDropdown(type) {
            const dropdown = document.getElementById(type + 'FilterDropdown');
            const otherType = type === 'user' ? 'action' : 'user';
            document.getElementById(otherType + 'FilterDropdown').classList.remove('show');
            dropdown.classList.toggle('show');
        }

        function selectFilter(type, value) {
            if (type === 'user') {
                activeUserFilter = value;
            } else {
                activeActionFilter = value;
            }
            document.getElementById(type + 'FilterDropdown').classList.remove('show');
            renderAuditFilters();
            filterAuditLogs();
        }

        // 点击其他地方关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.log-col-user') && !e.target.closest('.log-col-action')) {
                document.getElementById('userFilterDropdown')?.classList.remove('show');
                document.getElementById('actionFilterDropdown')?.classList.remove('show');
            }
        });

        function filterAuditLogs() {
            const keyword = document.getElementById('auditSearch').value.toLowerCase().trim();

            auditLogs = allAuditLogs.filter(log => {
                // 标签过滤
                if (activeUserFilter && log.user !== activeUserFilter) return false;
                if (activeActionFilter && log.action !== activeActionFilter) return false;
                // 关键字过滤
                if (keyword) {
                    const searchText = [log.timestamp, log.user, log.action, formatLogDetails(log.details)].join(' ').toLowerCase();
                    if (!searchText.includes(keyword)) return false;
                }
                return true;
            });

            auditCurrentPage = 1;
            renderAuditPage();
        }

        function renderAuditPage() {
            const logList = document.getElementById('logList');
            const pagination = document.getElementById('auditPagination');

            if (auditLogs.length === 0) {
                logList.innerHTML = '<div class="log-empty">No matching logs</div>';
                pagination.innerHTML = '';
                return;
            }

            const pageSize = getAuditPageSize();
            const totalPages = Math.ceil(auditLogs.length / pageSize);
            // 确保当前页在有效范围内
            if (auditCurrentPage > totalPages) auditCurrentPage = Math.max(1, totalPages);
            const start = (auditCurrentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageLogs = auditLogs.slice(start, end);

            logList.innerHTML = pageLogs.map(log => {
                const actionClass = getActionClass(log.action);
                const details = formatLogDetails(log.details);
                return `
                    <div class="log-item">
                        <span class="log-time">${log.timestamp}</span>
                        <span class="log-user">${ICON.USER}${log.user}</span>
                        <span class="log-action ${actionClass}">${log.action}</span>
                        <span class="log-details">${details}</span>
                    </div>
                `;
            }).join('');

            renderAuditPagination(totalPages);
        }

        function renderAuditPagination(totalPages) {
            renderPagination({
                elementId: 'auditPagination',
                currentPage: auditCurrentPage,
                totalPages,
                goPageFn: 'goAuditPage',
                totalItems: auditLogs.length
            });
        }

        function goAuditPage(page) {
            const pageSize = getAuditPageSize();
            const totalPages = Math.ceil(auditLogs.length / pageSize);
            if (page < 1 || page > totalPages) return;
            auditCurrentPage = page;
            renderAuditPage();
        }

        // 窗口大小变化时重新渲染分页
        window.addEventListener('resize', () => {
            if (historyBackups.length > 0 && document.getElementById('historyView').classList.contains('active')) {
                renderHistoryPage();
            }
            if (auditLogs.length > 0 && document.getElementById('auditLogs').classList.contains('active')) {
                renderAuditPage();
            }
            if (cronLogs.length > 0 && document.getElementById('cronLogs').classList.contains('active')) {
                renderCronPage();
            }
        });

        function getActionClass(action) {
            if (action.includes('login')) return 'login';
            if (action.includes('logout')) return 'logout';
            if (action.includes('add') || action.includes('create')) return 'add';
            if (action.includes('delete')) return 'delete';
            if (action.includes('update') || action.includes('toggle') || action.includes('save')) return 'update';
            return '';
        }

        function formatLogDetails(details) {
            if (!details) return '-';
            if (typeof details === 'string') return details;

            const parts = [];
            if (details.command) parts.push(`cmd: ${details.command}`);
            if (details.schedule) parts.push(`schedule: ${details.schedule}`);
            if (details.title) parts.push(`name: ${details.title}`);
            if (details.group_deleted) parts.push(`group deleted: ${details.group_deleted}`);
            if (details.old_schedule && details.new_schedule) {
                parts.push(`${details.old_schedule} → ${details.new_schedule}`);
            }
            if (details.action === 'enable') parts.push('enabled');
            if (details.action === 'disable') parts.push('disabled');
            if (details.enable !== undefined) parts.push(details.enable ? 'enabled' : 'disabled');
            if (details.length) parts.push(`${details.length} chars`);
            if (details.from_group !== undefined && details.to_group !== undefined) {
                parts.push(`group: ${details.from_group} → ${details.to_group}`);
            }

            return parts.length > 0 ? parts.join(' | ') : JSON.stringify(details);
        }

        // 加载Cron执行日志（支持远程机器）
        async function loadCronLogs() {
            const logList = document.getElementById('cronLogList');
            const pagination = document.getElementById('cronPagination');
            const sourceEl = document.getElementById('cronLogSource');
            const refreshBtn = document.querySelector('.refresh-btn');
            document.getElementById('cronSearch').value = '';

            // 添加旋转动画
            if (refreshBtn) {
                refreshBtn.classList.add('spinning');
                setTimeout(() => refreshBtn.classList.remove('spinning'), 600);
            }

            try {
                const resp = await fetch(`/api/cron_logs/${encodeURIComponent(currentMachine)}`);
                const data = await resp.json();

                sourceEl.textContent = data.source || '-';

                if (data.error) {
                    logList.innerHTML = `<div class="cron-log-error">${escapeHtml(data.error)}</div>`;
                    pagination.innerHTML = '';
                    allCronLogs = [];
                    cronLogs = [];
                    return;
                }

                if (!data.logs || data.logs.length === 0) {
                    logList.innerHTML = '<div class="log-empty">No cron execution logs found</div>';
                    pagination.innerHTML = '';
                    allCronLogs = [];
                    cronLogs = [];
                    return;
                }

                allCronLogs = data.logs;
                cronLogs = data.logs;
                cronCurrentPage = 1;
                renderCronPage();
            } catch (e) {
                logList.innerHTML = '<div class="cron-log-error">Failed to load cron logs</div>';
                pagination.innerHTML = '';
                sourceEl.textContent = '-';
                allCronLogs = [];
                cronLogs = [];
            }
        }

        function filterCronLogs() {
            const keyword = document.getElementById('cronSearch').value.toLowerCase().trim();

            cronLogs = allCronLogs.filter(line => {
                if (!keyword) return true;
                return line.toLowerCase().includes(keyword);
            });

            cronCurrentPage = 1;
            renderCronPage();
        }

        // 格式化时间为统一格式 YYYY-MM-DD HH:MM:SS
        function formatCronTime(timeStr) {
            // ISO 8601: 2026-01-05T21:04:02.768617+08:00 -> 2026-01-05 21:04:02
            const isoMatch = timeStr.match(/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2})/);
            if (isoMatch) {
                return `${isoMatch[1]} ${isoMatch[2]}`;
            }
            // Syslog: Jan  5 23:18:01 -> 2026-01-05 23:18:01
            const months = {Jan:'01',Feb:'02',Mar:'03',Apr:'04',May:'05',Jun:'06',Jul:'07',Aug:'08',Sep:'09',Oct:'10',Nov:'11',Dec:'12'};
            const syslogMatch = timeStr.match(/^(\w{3})\s+(\d+)\s+(\d+:\d+:\d+)$/);
            if (syslogMatch) {
                const month = months[syslogMatch[1]] || '01';
                const day = syslogMatch[2].padStart(2, '0');
                const year = new Date().getFullYear();
                return `${year}-${month}-${day} ${syslogMatch[3]}`;
            }
            return timeStr;
        }

        // 解析 cron log 行：time + host + details
        function parseCronLogLine(line) {
            // 格式1: ISO 8601 时间 - 2026-01-05T21:04:02.768617+08:00 host details...
            const isoMatch = line.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+[+-]\d{2}:\d{2})\s+(\S+)\s+(.+)$/);
            if (isoMatch) {
                return {
                    time: formatCronTime(isoMatch[1]),
                    host: isoMatch[2],
                    details: isoMatch[3]
                };
            }

            // 格式2: Syslog 时间 - Jan  5 23:18:01 host details...
            const syslogMatch = line.match(/^(\w{3}\s+\d+\s+\d+:\d+:\d+)\s+(\S+)\s+(.+)$/);
            if (syslogMatch) {
                return {
                    time: formatCronTime(syslogMatch[1]),
                    host: syslogMatch[2],
                    details: syslogMatch[3]
                };
            }

            // 无法解析，返回原始行
            return null;
        }

        // 格式化 details，高亮 CMD() 中的内容
        function formatCronDetails(details) {
            const escaped = escapeHtml(details);
            // 匹配 CMD (...) 并高亮括号内内容
            return escaped.replace(/CMD\s+\((.+)\)$/, 'CMD (<span class="cron-cmd-highlight">$1</span>)');
        }

        function renderCronPage() {
            const logList = document.getElementById('cronLogList');
            const pagination = document.getElementById('cronPagination');

            if (cronLogs.length === 0) {
                logList.innerHTML = '<div class="log-empty">No matching logs</div>';
                pagination.innerHTML = '';
                return;
            }

            const pageSize = getCronPageSize();
            const totalPages = Math.ceil(cronLogs.length / pageSize);
            if (cronCurrentPage > totalPages) cronCurrentPage = Math.max(1, totalPages);
            const start = (cronCurrentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageLogs = cronLogs.slice(start, end);

            logList.innerHTML = pageLogs.map(line => {
                const parsed = parseCronLogLine(line);
                if (parsed) {
                    return `<div class="cron-log-line">
                        <span class="cron-time">${escapeHtml(parsed.time)}</span>
                        <span class="cron-host">${ICON.HOST}${escapeHtml(parsed.host)}</span>
                        <span class="cron-details">${formatCronDetails(parsed.details)}</span>
                    </div>`;
                } else {
                    return `<div class="cron-log-line"><span class="cron-raw">${escapeHtml(line)}</span></div>`;
                }
            }).join('');

            renderCronPagination(totalPages);
        }

        function renderCronPagination(totalPages) {
            renderPagination({
                elementId: 'cronPagination',
                currentPage: cronCurrentPage,
                totalPages,
                goPageFn: 'goCronPage',
                totalItems: cronLogs.length
            });
        }

        function goCronPage(page) {
            const pageSize = getCronPageSize();
            const totalPages = Math.ceil(cronLogs.length / pageSize);
            if (page < 1 || page > totalPages) return;
            cronCurrentPage = page;
            renderCronPage();
        }

        // ========== 机器管理 ==========

        // 加载机器列表
        async function loadMachines() {
            try {
                const res = await fetch('/api/machines');
                const data = await res.json();
                // 将数组转换为以 id 为 key 的对象
                machines = {};
                data.machines.forEach(m => {
                    machines[m.id] = m;
                });
                currentMachine = data.default || 'local';

                // 填充机器选择器（user@machine 格式）
                const select = document.getElementById('machineSelect');
                select.innerHTML = '';
                const defaultUser = (machines[currentMachine]?.linux_users || ['root'])[0] || 'root';
                currentLinuxUser = defaultUser;
                for (const [id, config] of Object.entries(machines)) {
                    const users = config.linux_users || ['root'];
                    users.forEach((user, idx) => {
                        const option = document.createElement('option');
                        const userName = user || 'root';
                        option.value = `${userName}@${id}`;
                        option.textContent = `${userName}@${config.name || id}`;
                        if (id === currentMachine && idx === 0) option.selected = true;
                        select.appendChild(option);
                    });
                }

                // 检查连接状态
                checkMachineStatus();
            } catch (e) {
                console.error('Failed to load machines:', e);
            }
        }

        // 获取当前 machine+user 的存储 key
        function getCollapsedStateKey() {
            return `${currentMachine}:${currentLinuxUser}`;
        }

        // 保存当前折叠状态到 Map
        function saveCurrentCollapsedState() {
            const key = getCollapsedStateKey();
            const collapsed = [];
            document.querySelectorAll('.task-group.collapsed').forEach(g => {
                collapsed.push(g.dataset.groupId);
            });
            collapsedStateMap.set(key, collapsed);
        }

        // 恢复折叠状态（如无保存状态则默认全部折叠）
        function restoreOrCollapseAll() {
            const key = getCollapsedStateKey();
            if (collapsedStateMap.has(key)) {
                // 恢复保存的状态
                const collapsedIds = collapsedStateMap.get(key);
                document.querySelectorAll('.task-group').forEach(g => {
                    if (collapsedIds.includes(g.dataset.groupId)) {
                        g.classList.add('collapsed');
                    } else {
                        g.classList.remove('collapsed');
                    }
                });
            } else {
                // 首次访问，默认全部折叠
                document.querySelectorAll('.task-group').forEach(g => {
                    g.classList.add('collapsed');
                });
            }
            updateCollapseToggleBtn();
        }

        // 切换机器（解析 user@machineId 格式）
        async function switchMachine(value) {
            // 保存当前折叠状态
            saveCurrentCollapsedState();
            // 解析 user@machineId 格式
            const [user, machineId] = value.split('@');
            currentLinuxUser = user || 'root';
            currentMachine = machineId;
            await checkMachineStatus();
            refreshCurrentTab();
        }

        // 刷新当前标签页内容
        async function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return;

            const tabText = activeTab.textContent.trim();
            if (tabText === 'Task List') {
                await loadTasks();
                restoreOrCollapseAll();
                filterTasks();
            } else if (tabText === 'Raw Version') {
                loadRaw();
                loadHistory();
            } else if (tabText === 'Cron Logs') {
                loadCronLogs();
            } else if (tabText === 'Audit Logs') {
                loadAuditLogs();
            }
        }


        // 检查机器连接状态
        async function checkMachineStatus() {
            const dot = document.getElementById('connectionStatus');
            dot.className = 'status-dot checking';
            dot.title = 'Checking connection...';

            try {
                const res = await fetch(`/api/machine/${currentMachine}/status`);
                const data = await res.json();
                if (data.success) {
                    dot.className = 'status-dot connected';
                    dot.title = `Connected: ${data.message}`;
                } else {
                    dot.className = 'status-dot disconnected';
                    dot.title = `Disconnected: ${data.error || data.message}`;
                }
            } catch (e) {
                dot.className = 'status-dot disconnected';
                dot.title = 'Connection error';
            }
        }

        // 获取 API 路径（带机器参数）
        function getApiPath(base) {
            const user = currentLinuxUser || 'root';
            return `${base}/${encodeURIComponent(currentMachine)}/${encodeURIComponent(user)}`;
        }

        // ========== 数据加载与渲染 ==========

        async function loadTasks() {
            const resp = await fetch(getApiPath('/api/tasks'));
            groups = await resp.json();
            renderTasks();
        }

        // 渲染单个任务（内联编辑模式）
        function renderTask(task, groupId, group) {
            const parts = task.schedule.split(/\s+/);
            const [minute, hour, day, month, weekday] = parts.length >= 5 ? parts : ['*', '*', '*', '*', '*'];
            const cronDescription = parseCronToHuman(minute, hour, day, month, weekday);
            // 直接使用任务名
            const displayName = task.name;
            const noPerm = USER_CAN_EDIT ? '' : ' no-permission';
            const taskName = displayName
                ? `<span class="task-name editable" ${USER_CAN_EDIT ? `ondblclick="editTaskName(${task.id},this)" title="Double-click to edit"` : ''}>${escapeHtml(displayName)}</span>`
                : `<span class="task-name task-name-empty editable" ${USER_CAN_EDIT ? `ondblclick="editTaskName(${task.id},this)" title="Double-click to edit"` : ''}>Unnamed Task</span>`;
            const groupLabel = `<span class="task-group-label" onclick="goToGroup(${groupId})" title="Click to jump to group">${escapeHtml(group.title || 'Unnamed Group')}</span>`;

            return `
            <div class="task-card ${task.enabled ? '' : 'disabled'}" id="task-${task.id}"
                 data-task-id="${task.id}" data-group-id="${groupId}"
                 data-minute="${encodeURIComponent(minute)}" data-hour="${encodeURIComponent(hour)}" data-day="${encodeURIComponent(day)}"
                 data-month="${encodeURIComponent(month)}" data-weekday="${encodeURIComponent(weekday)}" data-command="${encodeURIComponent(task.command)}"
                 data-name="${encodeURIComponent(task.name || '')}"
                 draggable="false" ondragstart="dragTaskStart(event)" ondragend="dragEnd(event)" ondragover="dragTaskOver(event)" ondragleave="dragTaskLeave(event)" ondrop="dropTask(event)">
                <span class="drag-handle${noPerm}" title="Drag to reorder" ${USER_CAN_EDIT ? `onmousedown="enableDrag(this.parentElement)" onmouseup="disableDrag(this.parentElement)" ontouchstart="enableDrag(this.parentElement)" ontouchend="disableDrag(this.parentElement)"` : ''}>⋮⋮</span>
                <div class="toggle ${task.enabled ? 'on' : ''}${noPerm}" ${USER_CAN_EDIT ? `onclick="toggleTask(${task.id})"` : ''}></div>
                <div class="task-info">
                    <div class="task-name-row">${taskName}${groupLabel}</div>
                    <div class="task-schedule-wrapper">
                        <div class="cron-tooltip">${cronDescription}</div>
                        <div class="task-schedule">
                            <span class="${USER_CAN_EDIT ? 'editable ' : ''}time-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'minute',this)"` : ''} title="Minute">${minute}</span>
                            <span class="${USER_CAN_EDIT ? 'editable ' : ''}time-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'hour',this)"` : ''} title="Hour">${hour}</span>
                            <span class="${USER_CAN_EDIT ? 'editable ' : ''}time-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'day',this)"` : ''} title="Day">${day}</span>
                            <span class="${USER_CAN_EDIT ? 'editable ' : ''}time-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'month',this)"` : ''} title="Month">${month}</span>
                            <span class="${USER_CAN_EDIT ? 'editable ' : ''}time-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'weekday',this)"` : ''} title="Weekday">${weekday}</span>
                        </div>
                    </div>
                    <div class="task-command">
                        <span class="${USER_CAN_EDIT ? 'editable ' : ''}cmd-field" ${USER_CAN_EDIT ? `ondblclick="editField(${task.id},'command',this)"` : ''}>${escapeHtml(task.command)}</span>
                    </div>
                </div>
                <div class="task-actions">
                    <button class="detail-btn" onclick="showTaskDetail(${task.id})" title="Details">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                    </button>
                    <button class="run-btn${noPerm}" ${USER_CAN_EDIT ? `onclick="runTask(${task.id})"` : ''} title="Run Now">▶</button>
                    <button class="delete-btn${noPerm}" ${USER_CAN_EDIT ? `onclick="deleteTask(${task.id})"` : ''} title="Delete">×</button>
                </div>
            </div>`;
        }

        // 渲染任务列表（按分组）
        function renderTasks() {
            const container = document.getElementById('taskList');
            if (groups.length === 0) {
                container.innerHTML = '<p style="color:#666;padding:20px;">No crontab tasks</p>';
                return;
            }

            const noPerm = USER_CAN_EDIT ? '' : ' no-permission';
            container.innerHTML = groups.map(group => {
                const enabledCount = group.tasks.filter(t => t.enabled).length;
                const allEnabled = enabledCount === group.tasks.length;
                const allDisabled = enabledCount === 0;
                const partial = !allEnabled && !allDisabled;
                const switchClass = allEnabled ? 'on' : (partial ? 'partial' : '');
                return `
                <div class="task-group${allDisabled ? ' disabled' : ''}" id="group-${group.id}" data-group-id="${group.id}" data-title="${escapeHtml(group.title || '')}"
                     draggable="false" ondragstart="dragGroupStart(event)" ondragend="dragEnd(event)" ondragover="dragGroupOver(event)" ondrop="dropGroup(event)">
                    <div class="group-header" onclick="toggleGroupCollapse(${group.id})">
                        <span class="drag-handle group-drag-handle${noPerm}" title="Drag to reorder" onclick="event.stopPropagation()" ${USER_CAN_EDIT ? `onmousedown="enableDrag(this.closest('.task-group'))" onmouseup="disableDrag(this.closest('.task-group'))" ontouchstart="enableDrag(this.closest('.task-group'))" ontouchend="disableDrag(this.closest('.task-group'))"` : ''}>⋮⋮</span>
                        <div class="group-toggle-switch ${switchClass}${noPerm}" ${USER_CAN_EDIT ? `onclick="event.stopPropagation();toggleGroupSwitch(${group.id},${!allEnabled})"` : 'onclick="event.stopPropagation()"'}></div>
                        <span class="group-title" onclick="event.stopPropagation()" ${USER_CAN_EDIT ? `ondblclick="event.stopPropagation();editGroupTitle(${group.id},this)" title="Double-click to edit"` : ''}>${group.title ? escapeHtml(group.title) : 'Unnamed Group'}</span>
                        <span class="group-count">${enabledCount}/${group.tasks.length}</span>
                        <button class="group-delete-btn${noPerm}" ${USER_CAN_EDIT ? `onclick="event.stopPropagation();deleteGroup(${group.id})"` : 'onclick="event.stopPropagation()"'} title="Delete group"></button>
                    </div>
                    <div class="group-tasks">
                        ${group.tasks.map(task => renderTask(task, group.id, group)).join('')}
                        <div class="group-drop-end${noPerm}" data-group-id="${group.id}" ${USER_CAN_EDIT ? `ondragover="dragDropEndOver(event)" ondragleave="dragDropEndLeave(event)" ondrop="dropToEnd(event)"` : ''}></div>
                        <div class="group-add-task-btn${noPerm}" ${USER_CAN_EDIT ? `onclick="showGroupAddForm(${group.id})"` : ''}><span class="plus-icon">+</span> New Task</div>
                        <div class="group-add-form" id="group-add-form-${group.id}">
                            <input type="text" id="g${group.id}-name" class="mini-name-input" placeholder="Task name (optional)">
                            <div class="mini-cron-inputs">
                                <input type="text" id="g${group.id}-minute" value="*" placeholder="Min" title="Minute">
                                <input type="text" id="g${group.id}-hour" value="*" placeholder="Hr" title="Hour">
                                <input type="text" id="g${group.id}-day" value="*" placeholder="Day" title="Day">
                                <input type="text" id="g${group.id}-month" value="*" placeholder="Mon" title="Month">
                                <input type="text" id="g${group.id}-weekday" value="*" placeholder="Wk" title="Weekday">
                            </div>
                            <div class="mini-command-row">
                                <input type="text" id="g${group.id}-command" placeholder="Enter command">
                                <button class="mini-add-btn" onclick="addTaskToGroup(${group.id})">Add</button>
                                <button class="mini-cancel-btn" onclick="hideGroupAddForm(${group.id})">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // ========== 组管理（折叠、创建、编辑、删除） ==========

        function toggleGroupCollapse(id) {
            document.getElementById(`group-${id}`).classList.toggle('collapsed');
            updateCollapseToggleBtn();
        }

        // 删除任务组
        async function deleteGroup(groupId) {
            if (!confirm('Delete this task group? This cannot be undone!')) return;
            await apiCall(`/api/delete_group/${groupId}`, { successMsg: 'Group deleted', errorPrefix: 'Delete failed' });
        }

        // 展开全部
        function expandAll() {
            document.querySelectorAll('.task-group').forEach(g => g.classList.remove('collapsed'));
            updateCollapseToggleBtn();
        }

        // 折叠全部
        function collapseAll() {
            document.querySelectorAll('.task-group').forEach(g => g.classList.add('collapsed'));
            updateCollapseToggleBtn();
        }

        // 切换全部折叠/展开
        function toggleAllGroups() {
            const groups = document.querySelectorAll('.task-group');
            const allCollapsed = Array.from(groups).every(g => g.classList.contains('collapsed'));
            if (allCollapsed) {
                expandAll();
            } else {
                collapseAll();
            }
        }

        // 更新折叠切换按钮状态
        function updateCollapseToggleBtn() {
            const btn = document.getElementById('collapseToggleBtn');
            if (!btn) return;
            const groups = document.querySelectorAll('.task-group');
            const allCollapsed = Array.from(groups).every(g => g.classList.contains('collapsed'));
            btn.classList.toggle('all-collapsed', allCollapsed);
            btn.title = allCollapsed ? 'Expand All' : 'Collapse All';
        }

        // 保存折叠状态（返回已折叠的组 ID 数组）
        function saveCollapsedState() {
            const collapsed = [];
            document.querySelectorAll('.task-group.collapsed').forEach(g => {
                collapsed.push(g.dataset.groupId);
            });
            return collapsed;
        }

        // 恢复折叠状态
        function restoreCollapsedState(collapsedIds) {
            document.querySelectorAll('.task-group').forEach(g => {
                if (collapsedIds.includes(g.dataset.groupId)) {
                    g.classList.add('collapsed');
                }
            });
        }

        // 加载任务并保持折叠状态
        async function loadTasksKeepState() {
            const collapsedIds = saveCollapsedState();
            await loadTasks();
            restoreCollapsedState(collapsedIds);
            updateCollapseToggleBtn();
            // 重新应用当前过滤模式和分页
            filterTasks();
        }

        // ========== 搜索过滤 ==========

        let currentFilter = 'all';
        let caseSensitive = false;
        let savedCollapsedState = []; // 保存离开 All 状态时的折叠状态

        // 任务列表分页
        let taskCurrentPage = 1;
        const GROUP_PAGE_SIZE = 20;  // All 模式每页任务组数
        const TASK_PAGE_SIZE = 10;   // Active/Paused 模式每页任务数

        function toggleCaseSensitive() {
            caseSensitive = !caseSensitive;
            taskCurrentPage = 1;
            document.getElementById('caseToggle').classList.toggle('active', caseSensitive);
            filterTasks();
        }

        function setFilter(filter) {
            const prevFilter = currentFilter;
            currentFilter = filter;

            // 切换过滤器时重置页码
            taskCurrentPage = 1;

            // 离开 All 时保存折叠状态
            if (prevFilter === 'all' && filter !== 'all') {
                savedCollapsedState = saveCollapsedState();
            }

            // Update UI
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            filterTasks();

            // 返回 All 时恢复折叠状态
            if (prevFilter !== 'all' && filter === 'all') {
                restoreCollapsedState(savedCollapsedState);
                updateCollapseToggleBtn();
            }
        }

        // 跳转到指定组（从 Active/Paused 视图跳转到 All 视图）
        function goToGroup(groupId) {
            // 切换到 All 视图
            setFilter('all');

            // 清空搜索框
            document.getElementById('searchBox').value = '';

            // 滚动到目标组
            setTimeout(() => {
                const groupEl = document.getElementById(`group-${groupId}`);
                if (groupEl) {
                    // 展开组
                    groupEl.classList.remove('collapsed');
                    // 滚动到可见位置
                    groupEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 高亮闪烁效果
                    groupEl.style.transition = 'box-shadow 0.3s ease';
                    groupEl.style.boxShadow = '0 0 0 2px var(--primary)';
                    setTimeout(() => {
                        groupEl.style.boxShadow = '';
                    }, 1500);
                }
            }, 100);
        }

        function filterTasks() {
            const rawKeyword = document.getElementById('searchBox').value.trim();
            const keyword = caseSensitive ? rawKeyword : rawKeyword.toLowerCase();

            const isFlatView = currentFilter !== 'all';
            document.getElementById('taskList').classList.toggle('flat-view', isFlatView);
            document.querySelector('.collapse-controls').classList.toggle('flat-mode', isFlatView);

            // 辅助函数：根据大小写敏感设置进行匹配
            const matchText = (text, kw) => {
                if (!kw) return true;
                return caseSensitive ? text.includes(kw) : text.toLowerCase().includes(kw);
            };

            // 收集可见的组和任务
            const visibleGroups = [];
            const visibleTasks = [];

            document.querySelectorAll('.task-group').forEach(groupEl => {
                const groupTitleEl = groupEl.querySelector('.group-title');
                const originalGroupTitle = groupEl.dataset.title || 'Unnamed Group';
                const tasks = groupEl.querySelectorAll('.task-card');
                let groupMatch = !isFlatView && matchText(originalGroupTitle, keyword);
                let groupVisibleTaskCount = 0;

                // 高亮组名 (only if not flat view)
                if (!isFlatView && keyword && groupMatch) {
                    groupTitleEl.innerHTML = highlightText(originalGroupTitle, keyword);
                } else if (!isFlatView) {
                    groupTitleEl.textContent = originalGroupTitle || 'Unnamed Group';
                }

                tasks.forEach(taskEl => {
                    const commandEl = taskEl.querySelector('.task-command .cmd-field');
                    const minute = decodeURIComponent(taskEl.dataset.minute);
                    const hour = decodeURIComponent(taskEl.dataset.hour);
                    const day = decodeURIComponent(taskEl.dataset.day);
                    const month = decodeURIComponent(taskEl.dataset.month);
                    const weekday = decodeURIComponent(taskEl.dataset.weekday);
                    const command = decodeURIComponent(taskEl.dataset.command);

                    const scheduleText = `${minute} ${hour} ${day} ${month} ${weekday}`;
                    const taskMatch = matchText(scheduleText, keyword) || matchText(command, keyword);

                    let statusMatch = true;
                    const isEnabled = taskEl.querySelector('.toggle').classList.contains('on');
                    if (currentFilter === 'active' && !isEnabled) statusMatch = false;
                    if (currentFilter === 'paused' && isEnabled) statusMatch = false;

                    const isTaskVisible = (keyword === '' || taskMatch || groupMatch) && statusMatch;

                    if (isTaskVisible) {
                        groupVisibleTaskCount++;
                        if (isFlatView) {
                            visibleTasks.push({ taskEl, commandEl, command, keyword, matchText });
                        }
                    }
                    // 标记任务是否可见（用于分页显示）
                    taskEl.dataset.visible = isTaskVisible ? '1' : '0';
                    // 先隐藏所有任务，稍后由分页逻辑显示
                    taskEl.style.display = 'none';

                    // 高亮命令（All 模式也需要）
                    if (!isFlatView && isTaskVisible && keyword && matchText(command, keyword)) {
                        commandEl.innerHTML = highlightText(command, keyword);
                    } else if (!isFlatView && isTaskVisible) {
                        commandEl.textContent = command;
                    }
                });

                // 判断组是否可见
                const isGroupVisible = (!isFlatView && (keyword === '' || groupMatch)) || groupVisibleTaskCount > 0;
                groupEl.style.display = 'none'; // 先隐藏，稍后由分页逻辑显示

                if (isGroupVisible) {
                    visibleGroups.push({ groupEl, groupVisibleTaskCount });
                    if (keyword !== '' || isFlatView) {
                        groupEl.classList.remove('collapsed');
                    }
                }
            });

            // 应用分页
            if (isFlatView) {
                // Active/Paused 模式：按任务分页
                applyTaskPagination(visibleTasks, visibleGroups);
            } else {
                // All 模式：按任务组分页
                applyGroupPagination(visibleGroups);
            }
        }

        // All 模式分页：按任务组
        function applyGroupPagination(visibleGroups) {
            const totalPages = Math.ceil(visibleGroups.length / GROUP_PAGE_SIZE);
            const start = (taskCurrentPage - 1) * GROUP_PAGE_SIZE;
            const end = start + GROUP_PAGE_SIZE;

            visibleGroups.forEach((item, index) => {
                if (index >= start && index < end) {
                    item.groupEl.style.display = 'block';
                    // 只显示可见的任务
                    item.groupEl.querySelectorAll('.task-card').forEach(taskEl => {
                        if (taskEl.dataset.visible === '1') {
                            taskEl.style.display = 'flex';
                        }
                    });
                }
            });

            renderTaskPagination(totalPages, visibleGroups.length, 'groups');
        }

        // Active/Paused 模式分页：按任务
        function applyTaskPagination(visibleTasks, visibleGroups) {
            const totalPages = Math.ceil(visibleTasks.length / TASK_PAGE_SIZE);
            const start = (taskCurrentPage - 1) * TASK_PAGE_SIZE;
            const end = start + TASK_PAGE_SIZE;

            // 记录哪些组有可见任务
            const groupsWithVisibleTasks = new Set();

            visibleTasks.forEach((item, index) => {
                if (index >= start && index < end) {
                    item.taskEl.style.display = 'flex';
                    groupsWithVisibleTasks.add(item.taskEl.closest('.task-group'));

                    // 高亮命令
                    if (item.keyword && item.matchText(item.command, item.keyword)) {
                        item.commandEl.innerHTML = highlightText(item.command, item.keyword);
                    } else {
                        item.commandEl.textContent = item.command;
                    }
                }
            });

            // 显示有可见任务的组
            groupsWithVisibleTasks.forEach(groupEl => {
                groupEl.style.display = 'block';
            });

            renderTaskPagination(totalPages, visibleTasks.length, 'tasks');
        }

        // 渲染任务分页控件
        function renderTaskPagination(totalPages, totalItems, itemType) {
            renderPagination({
                elementId: 'taskPagination',
                currentPage: taskCurrentPage,
                totalPages,
                goPageFn: 'goTaskPage',
                totalItems,
                itemType,
                showDisplay: true
            });
        }

        // 跳转到指定页
        function goTaskPage(page) {
            const isFlatView = currentFilter !== 'all';
            // 需要重新计算总页数
            taskCurrentPage = page;
            filterTasks();
        }

        // 显示新建任务组表单
        function showNewGroupForm() {
            document.getElementById('newGroupForm').classList.add('active');
            document.getElementById('newGroupTitle').focus();
        }

        // 隐藏新建任务组表单
        function hideNewGroupForm() {
            document.getElementById('newGroupForm').classList.remove('active');
            document.getElementById('newGroupTitle').value = '';
        }

        // 创建新任务组
        async function createGroup() {
            const title = document.getElementById('newGroupTitle').value.trim();
            if (!title) {
                showMessage('Please enter group name', 'error');
                return;
            }

            const resp = await fetch('/api/create_group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Group created', 'success');
                hideNewGroupForm();
                loadTasksKeepState();
            } else {
                showMessage('Create failed: ' + result.error, 'error');
            }
        }

        // 显示组内添加任务表单
        function showGroupAddForm(groupId) {
            document.getElementById(`group-add-form-${groupId}`).classList.add('active');
            document.getElementById(`g${groupId}-command`).focus();
        }

        // 隐藏组内添加任务表单
        function hideGroupAddForm(groupId) {
            document.getElementById(`group-add-form-${groupId}`).classList.remove('active');
            // 重置表单
            document.getElementById(`g${groupId}-name`).value = '';
            document.getElementById(`g${groupId}-minute`).value = '*';
            document.getElementById(`g${groupId}-hour`).value = '*';
            document.getElementById(`g${groupId}-day`).value = '*';
            document.getElementById(`g${groupId}-month`).value = '*';
            document.getElementById(`g${groupId}-weekday`).value = '*';
            document.getElementById(`g${groupId}-command`).value = '';
        }

        // 向组内添加任务
        async function addTaskToGroup(groupId) {
            const name = document.getElementById(`g${groupId}-name`).value.trim();
            const minute = document.getElementById(`g${groupId}-minute`).value.trim() || '*';
            const hour = document.getElementById(`g${groupId}-hour`).value.trim() || '*';
            const day = document.getElementById(`g${groupId}-day`).value.trim() || '*';
            const month = document.getElementById(`g${groupId}-month`).value.trim() || '*';
            const weekday = document.getElementById(`g${groupId}-weekday`).value.trim() || '*';
            const command = document.getElementById(`g${groupId}-command`).value.trim();

            if (!command) {
                showMessage('Please enter command', 'error');
                return;
            }

            const schedule = `${minute} ${hour} ${day} ${month} ${weekday}`;
            const body = { schedule, command, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' };
            if (name) body.name = name;
            const resp = await fetch(`/api/add_to_group/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Task added', 'success');
                hideGroupAddForm(groupId);
                loadTasksKeepState();
            } else {
                showMessage('Add failed: ' + result.error, 'error');
            }
        }

        // 双击编辑组名称
        function editGroupTitle(groupId, element) {
            const groupEl = document.getElementById(`group-${groupId}`);
            const currentTitle = groupEl.dataset.title || '';
            const originalText = element.textContent;

            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.placeholder = 'Enter group name';

            element.textContent = '';
            element.appendChild(input);
            input.focus();
            input.select();

            // 保存函数
            const save = async () => {
                const newTitle = input.value.trim();
                if (!newTitle) {
                    element.textContent = originalText;
                    return;
                }

                const resp = await fetch(`/api/update_group_title/${groupId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage('Group renamed', 'success');
                    loadTasksKeepState();
                } else {
                    showMessage('Rename failed: ' + result.error, 'error');
                    element.textContent = originalText;
                }
            };

            // 取消函数
            const cancel = () => {
                element.textContent = originalText;
            };

            // 事件处理
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') { input.blur(); }
                if (e.key === 'Escape') { input.onblur = cancel; input.blur(); }
            };
        }

        // 启用/禁用整个组
        async function toggleGroupSwitch(groupId, enable) {
            // 先更新 UI
            const groupEl = document.getElementById(`group-${groupId}`);
            const switchEl = groupEl.querySelector('.group-toggle-switch');
            const prevClass = switchEl.className;
            switchEl.classList.remove('on', 'partial');
            if (enable) switchEl.classList.add('on');
            groupEl.classList.toggle('disabled', !enable);

            // 更新组内所有任务的 UI
            groupEl.querySelectorAll('.task-card').forEach(card => {
                const toggle = card.querySelector('.toggle');
                if (enable) {
                    toggle.classList.add('on');
                    card.classList.remove('disabled');
                } else {
                    toggle.classList.remove('on');
                    card.classList.add('disabled');
                }
            });

            const resp = await fetch(`/api/toggle_group/${groupId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage(enable ? 'Group enabled' : 'Group disabled', 'success');
                setTimeout(() => loadTasksKeepState(), 300);
            } else {
                // Restore state
                switchEl.className = prevClass;
                showMessage('Operation failed: ' + result.error, 'error');
                loadTasksKeepState();
            }
        }

        // ========== 任务管理（编辑、删除、运行） ==========

        function editField(taskId, field, element) {
            const card = document.getElementById(`task-${taskId}`);
            const currentValue = decodeURIComponent(card.dataset[field]);
            const isCmd = field === 'command';

            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = isCmd ? 'cmd-input' : 'time-input';
            input.value = currentValue;

            // 保存原始内容
            const originalText = element.textContent;
            element.textContent = '';
            element.appendChild(input);
            input.focus();
            input.select();

            // 保存函数
            const save = async () => {
                const newValue = input.value.trim() || (isCmd ? '' : '*');
                if (isCmd && !newValue) {
                    showMessage('Command cannot be empty', 'error');
                    element.textContent = originalText;
                    return;
                }

                // 更新data属性
                card.dataset[field] = encodeURIComponent(newValue);
                element.textContent = newValue;

                // 获取所有字段值并保存
                const schedule = `${decodeURIComponent(card.dataset.minute)} ${decodeURIComponent(card.dataset.hour)} ${decodeURIComponent(card.dataset.day)} ${decodeURIComponent(card.dataset.month)} ${decodeURIComponent(card.dataset.weekday)}`;
                const command = decodeURIComponent(card.dataset.command);

                const resp = await fetch(`/api/update/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule, command, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage('Saved', 'success');
                } else {
                    showMessage('Save failed: ' + result.error, 'error');
                    element.textContent = originalText;
                    card.dataset[field] = encodeURIComponent(currentValue);
                }
            };

            // 取消函数
            const cancel = () => {
                element.textContent = originalText;
            };

            // 事件处理
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') { input.blur(); }
                if (e.key === 'Escape') { input.onblur = cancel; input.blur(); }
            };
        }

        // 编辑任务名
        async function editTaskName(taskId, element) {
            const card = document.getElementById(`task-${taskId}`);
            const currentName = decodeURIComponent(card.dataset.name || '');
            const isEmpty = element.classList.contains('task-name-empty');

            // 创建输入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'name-input';
            input.value = currentName;
            input.placeholder = 'Task name';
            input.style.cssText = 'width: 200px; padding: 2px 6px; font-size: 12px; border: 1px solid var(--primary); border-radius: 4px;';

            // 保存原始内容
            const originalText = element.textContent;
            element.textContent = '';
            element.appendChild(input);
            input.focus();
            input.select();

            // 保存函数
            const save = async () => {
                const newName = input.value.trim();

                const resp = await fetch(`/api/update_task_name/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
                });
                const result = await resp.json();

                if (result.success) {
                    card.dataset.name = encodeURIComponent(newName);
                    if (newName) {
                        element.textContent = newName;
                        element.classList.remove('task-name-empty');
                    } else {
                        element.textContent = 'Unnamed Task';
                        element.classList.add('task-name-empty');
                    }
                } else {
                    showMessage('Save failed: ' + result.error, 'error');
                    element.textContent = originalText;
                }
            };

            // 取消函数
            const cancel = () => {
                element.textContent = originalText;
            };

            // 事件处理
            input.onblur = save;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') { input.blur(); }
                if (e.key === 'Escape') { input.onblur = cancel; input.blur(); }
            };
        }

        // 显示任务详情
        function showTaskDetail(id) {
            const card = document.getElementById(`task-${id}`);
            const name = decodeURIComponent(card.dataset.name) || 'Unnamed Task';
            const command = decodeURIComponent(card.dataset.command);
            const minute = decodeURIComponent(card.dataset.minute);
            const hour = decodeURIComponent(card.dataset.hour);
            const day = decodeURIComponent(card.dataset.day);
            const month = decodeURIComponent(card.dataset.month);
            const weekday = decodeURIComponent(card.dataset.weekday);
            const schedule = `${minute} ${hour} ${day} ${month} ${weekday}`;
            const enabled = !card.classList.contains('disabled');

            alert(`Task Details\n\nName: ${name}\nSchedule: ${schedule}\nCommand: ${command}\nStatus: ${enabled ? 'Enabled' : 'Disabled'}`);
        }

        // Run task manually（手动运行任务）
        async function runTask(id) {
            const card = document.getElementById(`task-${id}`);
            const command = decodeURIComponent(card.dataset.command);

            // 显示确认对话框
            if (!confirm(`Run this task now?\n\nCommand: ${command}`)) {
                return;
            }

            const resp = await fetch(`/api/run/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage(`Task completed (code: ${result.returncode})`, 'success');
            } else {
                showMessage('Run failed: ' + result.error, 'error');
            }
        }

        // Delete task（带撤销功能）
        async function deleteTask(id) {
            // 获取任务信息用于撤销
            const card = document.getElementById(`task-${id}`);
            const groupId = card.dataset.groupId;
            const minute = decodeURIComponent(card.dataset.minute);
            const hour = decodeURIComponent(card.dataset.hour);
            const day = decodeURIComponent(card.dataset.day);
            const month = decodeURIComponent(card.dataset.month);
            const weekday = decodeURIComponent(card.dataset.weekday);
            const command = decodeURIComponent(card.dataset.command);
            const enabled = card.querySelector('.toggle').classList.contains('on');
            const schedule = `${minute} ${hour} ${day} ${month} ${weekday}`;

            const resp = await fetch(`/api/delete/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                // 显示撤销提示
                showUndoToast('Task deleted', {
                    type: 'delete_task',
                    groupId: parseInt(groupId),
                    schedule: schedule,
                    command: command,
                    enabled: enabled
                });
                loadTasksKeepState();
            } else {
                showMessage('Delete failed: ' + result.error, 'error');
            }
        }

        // 切换任务状态
        async function toggleTask(id) {
            // 先更新 UI
            const card = document.getElementById(`task-${id}`);
            const toggle = card.querySelector('.toggle');
            const isOn = toggle.classList.contains('on');
            toggle.classList.toggle('on');
            card.classList.toggle('disabled');

            // 更新所属任务组的开关状态
            const groupEl = card.closest('.task-group');
            if (groupEl) {
                updateGroupSwitchState(groupEl);
            }

            const resp = await fetch(`/api/toggle/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Status updated', 'success');
                // Delay refresh for transition effect
                setTimeout(() => loadTasksKeepState(), 300);
            } else {
                // Restore state
                toggle.classList.toggle('on');
                card.classList.toggle('disabled');
                if (groupEl) updateGroupSwitchState(groupEl);
                showMessage('Operation failed: ' + result.error, 'error');
            }
        }

        // 更新任务组开关状态
        function updateGroupSwitchState(groupEl) {
            const tasks = groupEl.querySelectorAll('.task-card');
            const toggles = groupEl.querySelectorAll('.task-card .toggle');
            let enabledCount = 0;
            toggles.forEach(t => { if (t.classList.contains('on')) enabledCount++; });

            const switchEl = groupEl.querySelector('.group-toggle-switch');
            const allEnabled = enabledCount === tasks.length;
            const allDisabled = enabledCount === 0;
            const partial = !allEnabled && !allDisabled;

            switchEl.classList.remove('on', 'partial');
            if (allEnabled) switchEl.classList.add('on');
            else if (partial) switchEl.classList.add('partial');

            groupEl.classList.toggle('disabled', allDisabled);

            // 更新计数显示
            const countEl = groupEl.querySelector('.group-count');
            if (countEl) countEl.textContent = `${enabledCount}/${tasks.length}`;
        }

        // ========== 原始编辑器 ==========

        async function loadRaw() {
            const resp = await fetch(getApiPath('/api/raw'));
            const data = await resp.json();
            document.getElementById('rawContent').value = data.content;
            updateHighlight();
        }

        // Crontab 单行语法高亮
        function highlightLine(line) {
            const escaped = escapeHtml(line);
            // 空行
            if (!line.trim()) return escaped;
            // 注释行
            if (line.trim().startsWith('#')) {
                // 被禁用的任务（# 开头但后面是 cron 格式）
                if (/^#\s*[\d\*]/.test(line.trim())) {
                    return `<span class="hl-disabled">${escaped}</span>`;
                }
                return `<span class="hl-comment">${escaped}</span>`;
            }
            // 环境变量 NAME=value
            const envMatch = line.match(/^([A-Z_][A-Z0-9_]*)\s*=\s*(.*)$/i);
            if (envMatch) {
                const key = escapeHtml(envMatch[1]);
                const val = escapeHtml(envMatch[2]);
                return `<span class="hl-env-key">${key}</span>=<span class="hl-env-value">${val}</span>`;
            }
            // Cron 任务行：分 时 日 月 周 命令
            const cronMatch = line.match(/^([\d\*\/\-,]+\s+[\d\*\/\-,]+\s+[\d\*\/\-,]+\s+[\d\*\/\-,]+\s+[\d\*\/\-,]+)\s+(.+)$/);
            if (cronMatch) {
                const schedule = escapeHtml(cronMatch[1]);
                const cmd = escapeHtml(cronMatch[2]);
                return `<span class="hl-schedule">${schedule}</span> <span class="hl-command">${cmd}</span>`;
            }
            return escaped;
        }

        // Crontab 多行语法高亮
        function highlightCrontab(text) {
            return text.split('\n').map(highlightLine).join('\n');
        }

        function updateHighlight() {
            const textarea = document.getElementById('rawContent');
            const highlight = document.getElementById('codeHighlight');
            highlight.innerHTML = highlightCrontab(textarea.value) + '\n';
        }

        function syncHighlightScroll() {
            const textarea = document.getElementById('rawContent');
            const highlight = document.getElementById('codeHighlight');
            highlight.scrollTop = textarea.scrollTop;
            highlight.scrollLeft = textarea.scrollLeft;
        }

        // 保存原始内容
        async function saveRaw() {
            const content = document.getElementById('rawContent').value;
            await apiCall('/api/save', { body: { content }, successMsg: 'Saved successfully', errorPrefix: 'Save failed', reload: false });
        }

        // 显示消息
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            setTimeout(() => { msg.className = 'message'; }, 3000);
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== 拖拽排序 ==========

        // 启用拖拽（仅在拖拽手柄上按下时）
        function enableDrag(element) {
            element.setAttribute('draggable', 'true');
        }

        // 禁用拖拽
        function disableDrag(element) {
            // 只有在非拖拽状态下才禁用，防止拖拽过程中被意外禁用
            if (!isDragging) {
                element.setAttribute('draggable', 'false');
            }
        }

        // 清除所有拖拽指示器
        function clearDragIndicators() {
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            document.querySelectorAll('.group-drop-end.visible').forEach(el => el.classList.remove('visible'));
            // 移除占位符元素
            if (dragPlaceholder && dragPlaceholder.parentNode) {
                dragPlaceholder.parentNode.removeChild(dragPlaceholder);
            }
            dragPlaceholder = null;
        }

        // 全局清理拖拽状态（更可靠的重置）
        function cleanupDragState() {
            if (dragRafId) {
                cancelAnimationFrame(dragRafId);
                dragRafId = null;
            }
            if (draggedElement) {
                draggedElement.classList.remove('dragging', 'dragging-collapsed');
                draggedElement.setAttribute('draggable', 'false');
            }
            clearDragIndicators();
            draggedElement = null;
            dragType = null;
            lastDragOverTarget = null;
            isDragging = false;
        }

        // 全局事件监听：处理拖拽在窗口外结束的情况
        document.addEventListener('dragend', cleanupDragState);
        window.addEventListener('blur', cleanupDragState);
        document.addEventListener('drop', function (e) {
            // 如果 drop 发生在非目标区域，也要清理状态
            setTimeout(cleanupDragState, 100);
        });

        // 组拖拽开始（仅折叠状态允许拖拽）
        function dragGroupStart(e) {
            if (!e.target.classList.contains('task-group')) return;
            // 仅折叠状态允许拖拽
            if (!e.target.classList.contains('collapsed')) {
                e.preventDefault();
                return;
            }
            isDragging = true;
            draggedElement = e.target;
            dragType = 'group';
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.groupId);

            // 延迟创建占位符（等拖影生成后）
            setTimeout(() => {
                if (!draggedElement) return;
                // 获取元素高度
                const rect = draggedElement.getBoundingClientRect();
                // 创建占位符在原位置
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder-group';
                dragPlaceholder.style.height = rect.height + 'px'; // 直接设置高度
                dragPlaceholder.addEventListener('dragover', (ev) => ev.preventDefault());
                dragPlaceholder.addEventListener('drop', dropGroup);
                // 插入到被拖拽元素之后
                draggedElement.parentNode.insertBefore(dragPlaceholder, draggedElement.nextSibling);
                // 记录原位置信息
                dragPlaceholder.dataset.targetGroupId = draggedElement.dataset.groupId;
                // 隐藏原元素
                draggedElement.classList.add('dragging-collapsed');
            }, 0);
        }

        // 任务拖拽开始
        function dragTaskStart(e) {
            if (!e.target.classList.contains('task-card')) return;
            isDragging = true;
            draggedElement = e.target;
            dragType = 'task';
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);

            // 延迟创建占位符（等拖影生成后）
            setTimeout(() => {
                if (!draggedElement) return;
                // 获取元素高度
                const rect = draggedElement.getBoundingClientRect();
                // 创建占位符在原位置
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder';
                dragPlaceholder.style.height = rect.height + 'px'; // 直接设置高度
                dragPlaceholder.addEventListener('dragover', (ev) => ev.preventDefault());
                dragPlaceholder.addEventListener('drop', dropTask);
                // 插入到被拖拽元素之后
                draggedElement.parentNode.insertBefore(dragPlaceholder, draggedElement.nextSibling);
                // 记录原位置信息
                dragPlaceholder.dataset.targetTaskId = draggedElement.dataset.taskId;
                dragPlaceholder.dataset.targetGroupId = draggedElement.dataset.groupId;
                dragPlaceholder.dataset.insertBefore = 'false';
                // 隐藏原元素
                draggedElement.classList.add('dragging-collapsed');
            }, 0);
        }

        // 拖拽结束
        function dragEnd(e) {
            cleanupDragState();
        }

        // 组拖拽悬停（带节流）
        function dragGroupOver(e) {
            e.preventDefault();
            if (dragType !== 'group') return;

            const target = e.target.closest('.task-group');
            if (!target || target === draggedElement) return;

            // 使用 RAF 节流
            if (dragRafId) return;

            const clientY = e.clientY;
            dragRafId = requestAnimationFrame(() => {
                dragRafId = null;
                if (!isDragging || !target || !dragPlaceholder) return;

                // 计算鼠标相对于组的位置（添加死区）
                const rect = target.getBoundingClientRect();
                const deadZone = rect.height * 0.2;
                const midY = rect.top + rect.height / 2;

                // 死区检查
                if (lastDragOverTarget === target && Math.abs(clientY - midY) < deadZone) {
                    return;
                }

                const isTopHalf = clientY < midY;
                const targetParent = target.parentNode;
                const insertRef = isTopHalf ? target : target.nextSibling;
                const targetHeight = rect.height;

                // 位置变化时移动占位符
                if (dragPlaceholder.nextSibling !== insertRef || dragPlaceholder.parentNode !== targetParent) {
                    targetParent.insertBefore(dragPlaceholder, insertRef);
                    dragPlaceholder.style.height = targetHeight + 'px';
                }

                // 记录目标位置
                dragPlaceholder.dataset.targetGroupId = target.dataset.groupId;
                dragPlaceholder.dataset.insertBefore = isTopHalf ? 'true' : 'false';

                lastDragOverTarget = target;
            });
        }

        // 任务拖拽悬停（检测鼠标位置，插入占位符）- 使用 RAF 节流
        function dragTaskOver(e) {
            e.preventDefault();
            if (dragType !== 'task') return;

            const target = e.target.closest('.task-card');
            if (!target || target === draggedElement) return;

            // 使用 requestAnimationFrame 节流，避免频繁的 DOM 操作
            if (dragRafId) return;

            const clientY = e.clientY;
            dragRafId = requestAnimationFrame(() => {
                dragRafId = null;
                if (!isDragging || !target) return;

                // 清除末尾放置区
                document.querySelectorAll('.group-drop-end.visible').forEach(el => {
                    el.classList.remove('visible');
                });

                // 计算鼠标相对于卡片的位置（添加死区避免抖动）
                const rect = target.getBoundingClientRect();
                const deadZone = rect.height * 0.2; // 20% 死区
                const midY = rect.top + rect.height / 2;

                // 如果已有占位符且目标相同，检查是否在死区内
                if (dragPlaceholder && lastDragOverTarget === target) {
                    if (Math.abs(clientY - midY) < deadZone) {
                        return; // 在死区内，不改变位置
                    }
                }

                const isTopHalf = clientY < midY;

                // 占位符已在 dragTaskStart 中创建，这里只处理移动
                if (!dragPlaceholder) return;

                // 确定插入位置
                const targetParent = target.parentNode;
                const insertRef = isTopHalf ? target : target.nextSibling;
                const targetHeight = rect.height;

                // 位置变化时移动占位符
                if (dragPlaceholder.nextSibling !== insertRef || dragPlaceholder.parentNode !== targetParent) {
                    targetParent.insertBefore(dragPlaceholder, insertRef);
                    dragPlaceholder.style.height = targetHeight + 'px';
                }

                // 记录目标和位置，供 drop 使用
                dragPlaceholder.dataset.targetTaskId = target.dataset.taskId;
                dragPlaceholder.dataset.targetGroupId = target.dataset.groupId;
                dragPlaceholder.dataset.insertBefore = isTopHalf ? 'true' : 'false';

                lastDragOverTarget = target;
            });
        }

        // 任务拖拽离开
        function dragTaskLeave(e) {
            // 使用占位符后，不需要在 leave 时清理类名
            // 占位符会在 dragend 或 drop 时统一清理
        }

        // 组放置
        async function dropGroup(e) {
            e.preventDefault();
            if (dragType !== 'group' || !draggedElement) return;

            // 支持放置在占位符或组上
            const target = e.target.closest('.task-group') || (dragPlaceholder ? dragPlaceholder : null);
            if (!target) return;
            if (target.classList && target.classList.contains('task-group') && target === draggedElement) return;

            // 保存引用
            const elementToMove = draggedElement;
            const fromId = parseInt(elementToMove.dataset.groupId);

            // 从占位符获取目标信息
            let toId, insertBefore;
            if (dragPlaceholder && dragPlaceholder.dataset.targetGroupId) {
                toId = parseInt(dragPlaceholder.dataset.targetGroupId);
                insertBefore = dragPlaceholder.dataset.insertBefore === 'true';
            } else if (target.classList && target.classList.contains('task-group')) {
                toId = parseInt(target.dataset.groupId);
                const rect = target.getBoundingClientRect();
                insertBefore = e.clientY < rect.top + rect.height / 2;
            } else {
                return;
            }

            // 先用 DOM 操作将元素移动到占位符位置
            if (dragPlaceholder && dragPlaceholder.parentNode) {
                dragPlaceholder.parentNode.insertBefore(elementToMove, dragPlaceholder);
            }

            // 清理拖拽状态
            cleanupDragState();

            // 调用后端 API 重新排序
            const resp = await fetch('/api/reorder_groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ from_id: fromId, to_id: toId, insert_before: insertBefore, machine_id: currentMachine, linux_user: currentLinuxUser || 'root' })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Groups reordered', 'success');
                setTimeout(loadTasksKeepState, 300);
            } else {
                showMessage('Reorder failed: ' + result.error, 'error');
                loadTasksKeepState();
            }
        }

        // 任务放置
        async function dropTask(e) {
            e.preventDefault();
            if (dragType !== 'task' || !draggedElement) return;

            // 支持放置在占位符或任务卡片上
            const target = e.target.closest('.task-card') || (dragPlaceholder ? dragPlaceholder : null);
            if (!target) return;
            if (target.classList && target.classList.contains('task-card') && target === draggedElement) return;

            // 从占位符获取位置信息（优先），或者使用目标卡片的信息
            const elementToMove = draggedElement;
            let insertBefore, toTaskId, toGroupId;

            if (dragPlaceholder && dragPlaceholder.dataset.targetTaskId) {
                insertBefore = dragPlaceholder.dataset.insertBefore === 'true';
                toTaskId = parseInt(dragPlaceholder.dataset.targetTaskId);
                toGroupId = parseInt(dragPlaceholder.dataset.targetGroupId);
            } else if (target.classList && target.classList.contains('task-card')) {
                // 兜底：直接放在卡片上
                const rect = target.getBoundingClientRect();
                insertBefore = e.clientY < rect.top + rect.height / 2;
                toTaskId = parseInt(target.dataset.taskId);
                toGroupId = parseInt(target.dataset.groupId);
            } else {
                return; // 无有效目标
            }

            const fromTaskId = parseInt(elementToMove.dataset.taskId);
            const fromGroupId = parseInt(elementToMove.dataset.groupId);

            // 先用 DOM 操作将元素移动到占位符位置（即时视觉反馈）
            if (dragPlaceholder && dragPlaceholder.parentNode) {
                dragPlaceholder.parentNode.insertBefore(elementToMove, dragPlaceholder);
                // 更新 data-group-id（如果跨组移动）
                if (fromGroupId !== toGroupId) {
                    elementToMove.dataset.groupId = toGroupId;
                }
            }

            // 清理拖拽状态
            cleanupDragState();

            // 调用后端 API 重新排序
            const resp = await fetch('/api/reorder_tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    from_task_id: fromTaskId,
                    from_group_id: fromGroupId,
                    to_task_id: toTaskId,
                    to_group_id: toGroupId,
                    insert_before: insertBefore,
                    machine_id: currentMachine,
                    linux_user: currentLinuxUser || 'root'
                })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Tasks reordered', 'success');
                // 延迟加载以确保数据同步
                setTimeout(loadTasksKeepState, 300);
            } else {
                showMessage('Reorder failed: ' + result.error, 'error');
                loadTasksKeepState(); // 失败时重新加载以恢复原状
            }
        }

        // 末尾放置区悬停
        function dragDropEndOver(e) {
            e.preventDefault();
            if (dragType !== 'task') return;
            // 移除占位符
            if (dragPlaceholder && dragPlaceholder.parentNode) {
                dragPlaceholder.parentNode.removeChild(dragPlaceholder);
                dragPlaceholder = null;
            }
            // 显示当前末尾放置区
            e.target.classList.add('visible');
        }

        // 末尾放置区离开
        function dragDropEndLeave(e) {
            e.target.classList.remove('visible');
        }

        // 放置到组末尾
        async function dropToEnd(e) {
            e.preventDefault();
            if (dragType !== 'task' || !draggedElement) return;

            const dropZone = e.target.closest('.group-drop-end');
            if (!dropZone) return;

            // 保存引用
            const elementToMove = draggedElement;
            const fromTaskId = parseInt(elementToMove.dataset.taskId);
            const fromGroupId = parseInt(elementToMove.dataset.groupId);
            const toGroupId = parseInt(dropZone.dataset.groupId);

            // 先清理拖拽状态，防止卡住
            cleanupDragState();

            // 调用后端 API 移动到末尾
            const resp = await fetch('/api/move_task_to_end', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    task_id: fromTaskId,
                    from_group_id: fromGroupId,
                    to_group_id: toGroupId,
                    machine_id: currentMachine,
                    linux_user: currentLinuxUser || 'root'
                })
            });
            const result = await resp.json();
            if (result.success) {
                showMessage('Task moved', 'success');
                // 使用 DOM 操作移动节点到组末尾（dropZone 之前）
                dropZone.parentNode.insertBefore(elementToMove, dropZone);
                // 更新 data-group-id
                if (fromGroupId !== toGroupId) {
                    elementToMove.dataset.groupId = toGroupId;
                }
                // 延迟加载以确保数据同步
                setTimeout(loadTasksKeepState, 300);
            } else {
                showMessage('Move failed: ' + result.error, 'error');
                loadTasksKeepState();
            }
        }

        // ========== 用户管理 (仅 admin) ==========

        async function loadUsers() {
            if (!USER_CAN_ADMIN) return;
            try {
                const resp = await fetch('/api/users');
                if (!resp.ok) {
                    document.getElementById('userList').innerHTML = '<div class="log-empty">Permission denied</div>';
                    return;
                }
                const data = await resp.json();
                renderUserList(data.users);
            } catch (e) {
                document.getElementById('userList').innerHTML = `<div class="log-empty">Error: ${e.message}</div>`;
            }
        }

        function renderUserList(users) {
            const container = document.getElementById('userList');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="log-empty">No users</div>';
                return;
            }
            container.innerHTML = users.map(u => `
                <div class="user-item" data-username="${escapeHtml(u.username)}">
                    <span class="user-item-name">${escapeHtml(u.username)}</span>
                    <select class="user-role-select ${u.role}" onchange="changeUserRole('${escapeHtml(u.username)}', this.value)">
                        <option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>Viewer</option>
                        <option value="editor" ${u.role === 'editor' ? 'selected' : ''}>Editor</option>
                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                    <span class="user-item-machines">${u.machines.join(', ')}</span>
                    <div class="user-item-actions">
                        <button class="delete" onclick="deleteUser('${escapeHtml(u.username)}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            if (!username || !password) {
                showMessage('Username and password required', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role, machines: ['*'] })
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage('User created', 'success');
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('newRole').value = 'viewer';
                    loadUsers();
                } else {
                    showMessage(result.error || 'Failed', 'error');
                }
            } catch (e) {
                showMessage('Error: ' + e.message, 'error');
            }
        }

        async function changeUserRole(username, newRole) {
            try {
                const resp = await fetch(`/api/users/${encodeURIComponent(username)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage(`Role updated to ${newRole}`, 'success');
                    loadUsers();
                } else {
                    showMessage(result.error || 'Failed', 'error');
                    loadUsers(); // 重新加载以恢复原状态
                }
            } catch (e) {
                showMessage('Error: ' + e.message, 'error');
                loadUsers();
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user "${username}"?`)) return;

            try {
                const resp = await fetch(`/api/users/${encodeURIComponent(username)}`, {
                    method: 'DELETE'
                });
                const result = await resp.json();
                if (result.success) {
                    showMessage('User deleted', 'success');
                    loadUsers();
                } else {
                    showMessage(result.error || 'Failed', 'error');
                }
            } catch (e) {
                showMessage('Error: ' + e.message, 'error');
            }
        }

        // ========== 权限控制 ==========

        function applyPermissions() {
            // Viewer 模式: 无权限元素已通过 no-permission 类处理
            // 这里只需确保 Raw Editor 保持只读
            if (!USER_CAN_EDIT) {
                const rawContent = document.getElementById('rawContent');
                if (rawContent) rawContent.readOnly = true;
            }
        }

        // ========== 初始化 ==========
        // 首先加载机器列表，然后加载任务并折叠所有组
        loadMachines().then(() => {
            loadTasks().then(() => {
                collapseAll();
                applyPermissions();
            });
        });
    </script>
</body>

</html>