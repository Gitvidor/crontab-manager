# Crontab 解析规则说明

## 核心概念

- **任务行**：已生效的 cron 任务 或 已注释的 cron 任务（`#` + cron表达式）
- **注释行**：普通注释（`#` 开头但不符合 cron 表达式格式）
- **空行**：不含任何字符的行，且多个连续空行视为一个空行

---

## 新组识别规则

以下两种情况标志着**开始新的任务组**：

### 情况一：任务 + 空行 + 注释行

空行前为任务行，且空行后紧跟注释行时，开始新组。

```
任务A
         ← 空行
# 注释   ← 新组开始
任务B
```

### 情况二：连续多行注释（≥2行）

出现连续2行及以上注释时，开始新组（忽略多行注释中间的空行）。

```
任务A
# 注释1  ← 连续注释开始，新组开始
# 注释2
任务B
```
```
任务A
# 注释1  ← 连续注释开始，新组开始
         ← 空行
# 注释2
任务B
```

```
任务A

# 注释1  ← 空行+连续注释，新组开始
# 注释2
任务B
```

---

## 组名识别规则

在确定新组开始后，按以下规则识别组名：

| 注释行数 | 组名选取 |
|----------|----------|
| 1行 | 该注释 = 组名 |
| 2行及以上 | 倒数第二行 = 组名 |

---

## 任务名识别规则

**规则**：任务行上方第一个非空行的注释行，若未被选为组名 → 作为该任务的任务名

---

## 完整示例

### 示例1：任务 + 空行 + 单行注释
```
任务A
         ← 空行
# 组名   ← 新组开始，组名
任务B    ← 无任务名
```

### 示例2：任务 + 空行 + 双行注释
```
任务A
         ← 空行
# 组名    ← 新组开始，倒数第二行 = 组名
# 任务名  ← 任务名
任务B
```

### 示例3：任务 + 无空行 + 双行注释
```
任务A
# 组名    ← 连续注释开始新组，倒数第二行 = 组名
# 任务名  ← 任务名
任务B
```

### 示例4：任务 + 无空行 + 单行注释（不开始新组）
```
任务A
# 任务名  ← 只有1行注释，不开始新组，仅作为任务名
任务B     ← 与任务A同组
```

### 示例5：三行连续注释
```
任务A

# 描述    ← 被忽略
# 组名    ← 倒数第二行 = 组名
# 任务名  ← 任务名
任务B
```

### 示例6：三行连续注释（中间包含空行）
```
任务A

# 描述    ← 被忽略
# 组名    ← 倒数第二行 = 组名
          ← 空行
# 任务名  ← 任务名
任务B
```

### 示例7：文件开头
```
# 组名    ← 视同空行后，单行注释 = 组名
任务A
```

### 示例8：文件开头 + 多行注释
```
# 组名    ← 倒数第二行 = 组名
# 任务名  ← 任务名
任务A
```

### 示例9：注释行下方没有任何任务行
```
# 描述    ← 被忽略
          ← 空行
# 描述    ← 被忽略
# 描述    ← 被忽略
← crontab结束
```

---

## 规则流程图

```
初始化：
  - comment_buffer = []          # 注释缓冲区
  - new_group_context = true     # 文件开头视同空行后
  - current_group = 新组

遍历每一行：
│
├─ 空行？
│   └─ 如果上一个非空行是任务行 → new_group_context = true
│      （多个连续空行视为一个）
│
├─ 注释行？
│   ├─ 加入 comment_buffer
│   └─ 如果 comment_buffer.length >= 2 → new_group_context = true
│      （情况二：连续多行注释触发新组）
│
└─ 任务行？
    │
    ├─ 【判断是否开始新组】
    │   条件：new_group_context == true 且 comment_buffer 非空
    │   │
    │   ├─ 是 → 结束当前组（如有任务），开始新组
    │   │       ├─ 1行注释 → 该注释 = 组名，任务无任务名
    │   │       └─ 多行注释 → 倒数第二行 = 组名，最后一行 = 任务名
    │   │
    │   └─ 否 → 保持当前组
    │           └─ 如果 comment_buffer 有1行 → 该注释 = 任务名
    │
    ├─ 任务加入当前组
    │
    └─ 重置状态
        ├─ 清空 comment_buffer
        └─ new_group_context = false

遍历结束：
  └─ 如果 current_group 有任务 → 保存该组
```

### 补充说明

| 场景 | new_group_context | comment_buffer | 结果 |
|------|-------------------|----------------|------|
| 空行 + 单行注释 + 任务 | true | 1行 | 新组，注释=组名 |
| 空行 + 多行注释 + 任务 | true | ≥2行 | 新组，倒数第二行=组名 |
| 无空行 + 多行注释 + 任务 | true（≥2行触发） | ≥2行 | 新组，倒数第二行=组名 |
| 无空行 + 单行注释 + 任务 | false | 1行 | 同组，注释=任务名 |
| 空行 + 任务（无注释） | true | 0行 | 同组（条件不满足） |

---

## 与旧规则的对比

| 特性 | 旧规则 | 新规则 |
|------|--------|--------|
| 组名标识 | `# xxx`（组内首行注释） | 位置推断（倒数第二行） |
| 任务名标识 | `##xxx`（双井号） | `# xxx`（单井号，位置推断） |
| 新组触发 | 仅空行 | 空行+注释 或 连续多行注释 |
| 用户学习成本 | 需记忆 `##` 语法 | 无特殊语法 |
